<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Citizen Issues - Civicsense AI</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='images/favicon.png') }}"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      :root {
        /* Light theme colors */
        --color-text-primary: #1f2936;
        --color-text-secondary: #64748b;
        --color-text-placeholder: #798eae;
        --color-bg-primary: #f8fafc;
        --color-bg-secondary: #e2e8f0;
        --color-bg-sidebar: #ffffff;
        --color-border-hr: #e2e8f0;
        --color-hover-primary: #3b82f6;
        --color-hover-secondary: #f1f5f9;
        --color-accent: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-shadow: rgba(0, 0, 0, 0.08);
        --color-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --sidebar-width: 280px;
        --sidebar-collapsed-width: 80px;
      }

      body.dark-theme {
        /* Dark theme colors */
        --color-text-primary: #f1f5f9;
        --color-text-secondary: #94a3b8;
        --color-text-placeholder: #a6b7d2;
        --color-bg-primary: #0f172a;
        --color-bg-secondary: #1e293b;
        --color-bg-sidebar: #1e293b;
        --color-border-hr: #334155;
        --color-hover-primary: #3b82f6;
        --color-hover-secondary: #334155;
        --color-accent: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-shadow: rgba(0, 0, 0, 0.3);
        --color-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      body {
        min-height: 100vh;
        background: var(--color-bg-primary);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--color-bg-sidebar);
        border-right: 1px solid var(--color-border-hr);
        box-shadow: 0 4px 20px var(--color-shadow);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1001;
      }

      .sidebar-header {
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--color-border-hr);
        background: white; /* ‚¨ÖÔ∏è changed from gradient to white */
        color: #0d47a1; /* ‚¨ÖÔ∏è updated text color for visibility */
        position: relative;
      }

      .header-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        transition: opacity 0.4s ease;
      }

      .header-logo {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .header-title {
        font-size: 1.2rem;
        font-weight: 600;
        transition: opacity 0.4s ease;
      }

      .centered-logo {
        width: 100%;
        display: flex;
        justify-content: center; /* centers horizontally */
        align-items: center;
      }

      .logo-img {
        height: 100px; /* üîº Increased size */
        width: auto;
        object-fit: contain;
      }

      .sidebar-toggle {
        height: 36px;
        width: 36px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: white;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .sidebar-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .sidebar-toggle span {
        font-size: 1.4rem;
        transition: transform 0.4s ease;
      }

      .sidebar-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--color-text-placeholder) transparent;
      }

      .sidebar-content::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .sidebar-content::-webkit-scrollbar-thumb {
        background: var(--color-text-placeholder);
        border-radius: 3px;
      }

      .menu-section-title {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
        padding: 0 12px;
        transition: opacity 0.3s ease;
      }

      .menu-list {
        display: flex;
        gap: 4px;
        list-style: none;
        flex-direction: column;
      }

      .menu-link {
        display: flex;
        gap: 12px;
        white-space: nowrap;
        border-radius: 12px;
        padding: 12px 16px;
        align-items: center;
        text-decoration: none;
        color: var(--color-text-primary);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .menu-link::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background: var(--color-hover-primary);

        z-index: -1;
      }

      /* Style for the currently ACTIVE page link (solid blue) */
      .menu-link.active {
        color: white;
      }
      .menu-link.active::before {
        width: 100%;
      }

      /* Replace it with this code */
      .menu-link:not(.logout-menu-link):not(.active):hover {
        background-color: var(--color-hover-secondary);
      }
      .menu-link .menu-icon {
        font-size: 1.3rem;
        min-width: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .menu-label {
        font-size: 0.95rem;
        font-weight: 500;
        transition: opacity 0.3s ease;
      }

      .status-badge {
        background: var(--color-accent);
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: auto;
        font-weight: 500;
      }

      .divider {
        height: 1px;
        background: var(--color-border-hr);
        margin: 16px 0;
      }

      .sidebar-footer {
        padding: 20px;
        border-top: 1px solid var(--color-border-hr);
        background: var(--color-bg-secondary);
      }

      .theme-toggle {
        width: 100%;
        min-height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        cursor: pointer;
        border: none;
        padding: 0 16px;
        color: var(--color-text-primary);
        background: var(--color-bg-sidebar);
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: var(--color-hover-secondary);
      }

      .theme-label {
        display: flex;
        gap: 12px;
        align-items: center;
        flex: 1;
      }

      .theme-text {
        font-size: 0.95rem;
        font-weight: 500;
        transition: opacity 0.3s ease;
      }

      .theme-toggle-track {
        height: 24px;
        width: 48px;
        border-radius: 999px;
        background: var(--color-bg-secondary);
        position: relative;
        transition: all 0.3s ease;
      }

      body.dark-theme .theme-toggle-track {
        background: var(--color-hover-primary);
      }

      .theme-toggle-indicator {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      body.dark-theme .theme-toggle-indicator {
        transform: translateX(24px);
      }

      /* Fixed main content area */
      .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .main-content-inner {
        flex: 1;
        padding: 30px;
        color: var(--color-text-primary);
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin: 0;
      }

      .page-subtitle {
        font-size: 1.1rem;
        color: var(--color-text-secondary);
        margin-top: 8px;
      }

      .status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .status-card {
        background: var(--color-bg-sidebar);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 12px var(--color-shadow);
        transition: all 0.3s ease;
        border: 1px solid var(--color-border-hr);
      }

      .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px var(--color-shadow);
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: white;
      }

      .card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 8px;
      }

      .card-description {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }

      .logout-btn {
        background: var(--color-error);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      .logout-menu-link {
        color: var(--color-error) !important;
      }

      /* Logout button hover + active styles */
      .logout-menu-link::before {
        display: none !important; /* remove sliding hover animation background */
      }

      .logout-menu-link:hover,
      .logout-menu-link.active {
        background: rgba(
          239,
          68,
          68,
          0.1
        ) !important; /* Very light red background */
        color: var(--color-error) !important; /* Solid red text */
        font-weight: 600;
      }

      .footer-section {
        background: var(--color-bg-secondary);
        border-top: 1px solid var(--color-border-hr);
        margin-top: auto;
        padding: 10px 0;
        transition: all 0.3s ease;
      }

      .footer-content {
        display: flex;
        flex-direction: column;
        text-align: center;
        justify-content: space-between;
        padding: 16px 24px;
        gap: 12px;
      }

      .footer-copyright {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
      }

      .footer-developer {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
      }

      .footer-developer a {
        color: #0d47a1;
        font-weight: bold;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .footer-developer a:hover {
        color: var(--color-hover-primary);
      }

      @media (min-width: 768px) {
        .footer-content {
          flex-direction: row;
          text-align: left;
        }
      }

      /* STYLES FOR MOBILE HEADER AND LOGO */
      .mobile-header {
        display: none;
      }
      .mobile-header-logo {
        height: 35px;
        width: auto;
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .mobile-overlay {
          display: block;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
          opacity: 1;
          pointer-events: auto;
        }

        .mobile-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 10px 20px;
          background: var(--color-bg-sidebar);
          border-bottom: 1px solid var(--color-border-hr);
          position: sticky;
          top: 0;
          z-index: 100;
        }

        .mobile-toggle {
          background: none;
          border: none;
          font-size: 1.8rem;
          color: var(--color-text-primary);
          cursor: pointer;
        }

        .status-cards {
          grid-template-columns: 1fr;
        }

        .main-content-inner {
          padding: 20px 15px;
        }

        .page-header {
          display: none;
        }
      }

      /* Variables from your existing design */
      :root {
        --color-text-primary: #1f2936;
        --color-text-secondary: #64748b;
        --color-text-placeholder: #798eae;
        --color-bg-primary: #f8fafc;
        --color-bg-secondary: #e2e8f0;
        --color-bg-sidebar: #ffffff;
        --color-border-hr: #e2e8f0;
        --color-hover-primary: #3b82f6;
        --color-hover-secondary: #f1f5f9;
        --color-accent: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-shadow: rgba(0, 0, 0, 0.08);
        --color-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      body.dark-theme {
        --color-text-primary: #f1f5f9;
        --color-text-secondary: #94a3b8;
        --color-text-placeholder: #a6b7d2;
        --color-bg-primary: #0f172a;
        --color-bg-secondary: #1e293b;
        --color-bg-sidebar: #1e293b;
        --color-border-hr: #334155;
        --color-hover-primary: #3b82f6;
        --color-hover-secondary: #334155;
        --color-accent: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-shadow: rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: var(--color-bg-primary);
        color: var(--color-text-primary);
        transition: all 0.3s ease;
      }

      .main-content-inner {
        padding: 30px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        background: linear-gradient(
          135deg,
          #ff7e5f 0%,
          #feb47b 100%
        ); /* Coral ‚Üí Peach */
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 4px 20px var(--color-shadow);
        border: 1px solid var(--color-border-hr);
        color: white; /* Set default text color to white */
      }

      .page-header .page-title,
      .page-header .page-title .material-symbols-rounded {
        color: white; /* Ensure title and icon are white */
      }
      .page-header .page-subtitle {
        color: white; /* Ensure subtitle is white */
        opacity: 0.8; /* Make it slightly transparent */
      }

      .page-header .progress-indicator {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-title .material-symbols-rounded {
        font-size: 2.2rem;
        color: var(--color-hover-primary);
      }

      .page-subtitle {
        font-size: 1.1rem;
        color: var(--color-text-secondary);
        margin-top: 8px;
      }

      .progress-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--color-bg-secondary);
        border-radius: 20px;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }

      .progress-step {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--color-hover-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
      }

      .form-container {
        background: var(--color-bg-sidebar);
        border-radius: 20px;
        padding: 32px;
        box-shadow: 0 4px 24px var(--color-shadow);
        border: 1px solid var(--color-border-hr);
        position: relative;
        overflow: hidden;
      }

      .form-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--color-gradient);
      }

      .form-section {
        margin-bottom: 40px;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--color-border-hr);
      }

      .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--color-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.4rem;
      }

      .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .form-grid {
        display: grid;
        gap: 24px;
        margin-bottom: 20px; /* Add this line to create vertical space. Adjust value as needed. */
      }

      .form-grid-2 {
        grid-template-columns: 1fr 1fr;
      }

      .form-grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }

      .form-group {
        position: relative;
      }

      .form-label {
        display: block;
        font-weight: 500;
        color: var(--color-text-primary);
        margin-bottom: 8px;
        font-size: 0.95rem;
      }

      .required {
        color: var(--color-error);
        margin-left: 2px;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 16px;
        border: 2px solid var(--color-border-hr);
        border-radius: 12px;
        font-size: 1rem;
        background: var(--color-bg-primary);
        color: var(--color-text-primary);
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--color-hover-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
      }

      .form-textarea {
        resize: vertical;
        min-height: 120px;
      }

      .input-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-placeholder);
        font-size: 1.2rem;
        pointer-events: none;
      }

      .form-group.has-icon .form-input {
        padding-right: 50px;
      }

      .priority-options {
        display: flex;
        gap: 16px;
        margin-top: 12px;
      }

      .priority-option {
        flex: 1;
        position: relative;
      }

      .priority-radio {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .priority-label {
        display: block;
        padding: 16px;
        border: 2px solid var(--color-border-hr);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        background: var(--color-bg-primary);
      }

      .priority-label.critical {
        border-color: var(--color-error);
        color: var(--color-error);
      }

      .priority-label.normal {
        border-color: var(--color-warning);
        color: var(--color-warning);
      }

      .priority-label.low {
        border-color: var(--color-accent);
        color: var(--color-accent);
      }

      .priority-radio:checked + .priority-label {
        background: var(--color-hover-primary);
        color: white;
        border-color: var(--color-hover-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
      }

      .file-upload-area {
        border: 2px dashed var(--color-border-hr);
        border-radius: 16px;
        padding: 32px;
        text-align: center;
        background: var(--color-bg-primary);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .file-upload-area:hover {
        border-color: var(--color-hover-primary);
        background: var(--color-hover-secondary);
      }

      .file-upload-area.dragover {
        border-color: var(--color-hover-primary);
        background: rgba(59, 130, 246, 0.1);
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3rem;
        color: var(--color-text-placeholder);
        margin-bottom: 16px;
      }

      .upload-text {
        font-size: 1.1rem;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
      }

      .upload-subtext {
        font-size: 0.9rem;
        color: var(--color-text-placeholder);
      }

      .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      .upload-buttons {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        justify-content: center;
      }

      .upload-btn {
        padding: 12px 24px;
        border: 2px solid var(--color-hover-primary);
        border-radius: 8px;
        background: transparent;
        color: var(--color-hover-primary);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .upload-btn:hover {
        background: var(--color-hover-primary);
        color: white;
        transform: translateY(-2px);
      }

      .file-preview {
        margin-top: 16px;
        display: none;
      }

      .preview-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--color-bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--color-border-hr);
      }

      .preview-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
      }

      .preview-info {
        flex: 1;
      }

      .preview-name {
        font-weight: 500;
        color: var(--color-text-primary);
        margin-bottom: 4px;
      }

      .preview-size {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }

      .remove-file {
        background: var(--color-error);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .remove-file:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      .consent-section {
        background: var(--color-bg-secondary);
        padding: 24px;
        border-radius: 16px;
        border: 1px solid var(--color-border-hr);
      }

      .consent-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
      }

      .consent-input {
        width: 20px;
        height: 20px;
        margin-top: 2px;
        cursor: pointer;
      }

      .consent-text {
        font-size: 0.95rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
      }

      .submit-section {
        display: flex;
        justify-content: flex-end; /* This moves both buttons to the right */
        gap: 16px; /* This adds a space between the buttons */
        align-items: center;
        margin-top: 40px;
        padding-top: 24px;
        border-top: 2px solid var(--color-border-hr);
      }
      .submit-btn {
        background: var(--color-gradient);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4);
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .reset-btn {
        background: transparent;
        color: var(--color-text-secondary);
        border: 2px solid var(--color-border-hr);
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .reset-btn:hover {
        border-color: var(--color-error);
        color: var(--color-error);
      }

      .custom-issue-input {
        margin-top: 16px;
        display: none;
      }

      .validation-message {
        color: var(--color-error);
        font-size: 0.9rem;
        margin-top: 8px;
        display: none;
      }

      .success-message {
        background: var(--color-accent);
        color: white;
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
        display: none;
        align-items: center;
        gap: 8px;
      }

      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .form-grid-2,
        .form-grid-3 {
          grid-template-columns: 1fr;
        }

        .priority-options {
          flex-direction: column;
        }

        .location-options {
          flex-direction: column;
        }

        .submit-section {
          flex-direction: column;
          gap: 16px;
        }

        .upload-buttons {
          flex-direction: column;
        }

        .main-content-inner {
          padding: 20px;
        }
      }

      .location-options {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      .location-btn {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--color-border-hr);
        border-radius: 8px;
        background: var(--color-bg-primary);
        color: var(--color-text-primary);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 140px;
      }

      .location-btn:hover {
        border-color: var(--color-hover-primary);
        background: var(--color-hover-secondary);
      }

      .location-btn:active {
        transform: translateY(1px);
      }

      .location-btn.active {
        background: var(--color-hover-primary);
        color: white;
        border-color: var(--color-hover-primary);
      }

      .location-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .search-container-with-icon {
        position: relative;
        display: flex;
        align-items: center;
        max-width: 400px;
        margin-bottom: 12px;
      }

      .search-container-with-icon .search-icon {
        position: absolute;
        left: 12px;
        font-size: 20px;
        color: var(--color-text-placeholder);
        pointer-events: none;
        z-index: 10;
      }

      .location-search {
        width: 100%;
        padding: 12px 16px 12px 40px;
        border: 2px solid var(--color-border-hr);
        border-radius: 8px;
        font-size: 1rem;
        background: var(--color-bg-primary);
        color: var(--color-text-primary);
        transition: all 0.3s ease;
      }

      .location-search:focus {
        outline: none;
        border-color: var(--color-hover-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .map-container {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        background: var(--color-bg-secondary);
        border: 2px solid var(--color-border-hr);
        position: relative;
        margin-bottom: 16px;
      }

      .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--color-text-secondary);
      }

      .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .map-control-btn {
        width: 40px;
        height: 40px;
        background: var(--color-bg-sidebar);
        border: 1px solid var(--color-border-hr);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--color-text-primary);
      }

      .map-control-btn:hover {
        background: var(--color-hover-primary);
        color: white;
      }

      .map-control-btn:active {
        transform: translateY(1px);
      }

      .location-info {
        background: var(--color-bg-sidebar);
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--color-border-hr);
        display: none;
      }

      .location-info.active {
        display: block;
      }

      .location-address {
        font-size: 0.95rem;
        color: var(--color-text-primary);
        margin-bottom: 4px;
      }

      .location-coords {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }

      .validation-message {
        color: var(--color-error);
        font-size: 0.9rem;
        margin-top: 8px;
        display: none;
      }

      .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: rgba(239, 68, 68, 0.1);
        color: var(--color-error);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .success-message {
        background: rgba(16, 185, 129, 0.1);
        color: var(--color-accent);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        border: 1px solid rgba(16, 185, 129, 0.2);
      }

      @media (max-width: 768px) {
        .location-options {
          flex-direction: column;
        }

        .location-btn {
          min-width: 100%;
        }

        .search-container-with-icon {
          max-width: 100%;
        }
      }

      #scrollToTopBtn {
        display: none; /* Hidden by default */
        position: fixed; /* Fixed/sticky position */
        bottom: 30px; /* Place the button 30px from the bottom */
        right: 30px; /* Place the button 30px from the right */
        z-index: 1000; /* Make sure it sits on top of other content */
        border: none; /* Remove borders */
        outline: none; /* Remove outline */
        background-color: var(--color-hover-primary); /* Use theme color */
        color: white; /* White text */
        cursor: pointer; /* Add a mouse pointer on hover */
        width: 50px; /* Set a width */
        height: 50px; /* Set a height */
        border-radius: 50%; /* Circular shape */
        box-shadow: 0 4px 12px var(--color-shadow);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        transition: opacity 0.3s ease, transform 0.3s ease;
        opacity: 0;
        transform: translateY(10px);
      }

      #scrollToTopBtn.visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* ADD THIS ENTIRE CSS BLOCK FOR THE MODAL */

      /* Styles for the modal pop-up */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }

      .modal-overlay.active {
        display: flex;
        opacity: 1;
      }

      .modal-content {
        background: var(--color-bg-sidebar);
        padding: 32px;
        border-radius: 16px;
        text-align: center;
        max-width: 450px;
        width: 90%;
        transform: scale(0.95);
        transition: transform 0.3s ease-in-out;
      }

      .modal-overlay.active .modal-content {
        transform: scale(1);
      }

      .modal-icon .material-symbols-rounded {
        font-size: 80px;
        color: var(--color-accent);
      }

      .modal-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .modal-message {
        font-size: 1rem;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
        line-height: 1.5;
      }

      /* --- NEW CSS FOR THE ISSUE ID DISPLAY --- */
      .modal-issue-id-container {
        background: var(--color-bg-secondary);
        padding: 12px;
        border-radius: 8px;
        margin: 16px 0 24px 0;
        border: 1px solid var(--color-border-hr);
      }

      .modal-issue-id-label {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }

      #modal-issue-id {
        font-weight: 600;
        color: var(--color-text-primary);
        font-size: 1.1rem;
        letter-spacing: 1px;
        user-select: all; /* Makes the ID easily copyable */
      }

      .modal-button {
        background: var(--color-hover-primary);
        color: white;
        border: none;
        padding: 12px 40px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
      }

      /* --- NEW: Sidebar Profile Picture Styles --- */
      .sidebar-profile-pic {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--color-border-hr);
        /* Placeholder background color */
        background-color: var(--color-bg-secondary);
      }

      /* --- NEW: Dark Mode Sidebar Header & Logo Styles --- */

      /* By default, hide the dark mode logo */
      .dark-mode-logo {
        display: none;
      }

      body.dark-theme .sidebar-header {
        background: var(--color-bg-sidebar); /* Match the dark sidebar color */
      }

      /* When dark mode is on, hide the light logo... */
      body.dark-theme .light-mode-logo {
        display: none;
      }

      /* ...and show the dark logo */
      body.dark-theme .dark-mode-logo {
        display: block;
        margin: 0 auto;
        transform: translateX(10px); /* ‚¨Ö adjust this value as per your need */
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="header-brand">
          <div class="header-brand centered-logo">
            <img
              src="{{ url_for('static', filename='images/Civicsense.png') }}"
              alt="Civicsense AI Logo"
              class="logo-img light-mode-logo"
            />
            <img
              src="{{ url_for('static', filename='images/Civicsense-dark.png') }}"
              alt="Civicsense AI Logo Dark"
              class="logo-img dark-mode-logo"
            />
          </div>
        </div>
      </div>
      <div class="sidebar-content">
        <!-- Main Menu -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="dashboard" class="menu-link active">
                <span class="material-symbols-rounded menu-icon"
                  >dashboard</span
                >
                <span class="menu-label">Dashboard</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="report-issue" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >report_problem</span
                >
                <span class="menu-label">Report an Issue</span>
              </a>
            </li>

            <li class="menu-item">
              <a href="my-submissions" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >description</span
                >
                <span class="menu-label">My Submissions</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="check-status" class="menu-link">
                <span class="material-symbols-rounded menu-icon">task_alt</span>
                <span class="menu-label">Check Status</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- AI & Analytics -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="chatbot" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >smart_toy</span
                >
                <span class="menu-label">AI Chatbot</span>
              </a>
            </li>

            <li class="menu-item">
              <a href="analytics" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >trending_up</span
                >
                <span class="menu-label">Analytics & Trends</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Support -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="feedback" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >star_rate</span
                >
                <span class="menu-label">Feedback & Rating</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="help-support" class="menu-link">
                <span class="material-symbols-rounded menu-icon">help</span>
                <span class="menu-label">Help/Support</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="about-us" class="menu-link">
                <span class="material-symbols-rounded menu-icon">info</span>
                <span class="menu-label">About Us</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Account -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="my-profile" class="menu-link">
                <img
                  src=""
                  alt="My Profile"
                  id="sidebarProfilePic"
                  class="sidebar-profile-pic"
                />
                <span class="menu-label">My Profile</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="logout" class="menu-link logout-menu-link">
                <span class="material-symbols-rounded menu-icon">logout</span>
                <span class="menu-label">Logout</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Theme Toggle -->
        <button class="theme-toggle">
          <div class="theme-label">
            <span class="material-symbols-rounded">dark_mode</span>
            <span class="theme-text">Dark Mode</span>
          </div>
          <div class="theme-toggle-track">
            <div class="theme-toggle-indicator"></div>
          </div>
        </button>
      </div>
    </aside>

    <div class="main-content">
      <div class="mobile-header">
        <button class="mobile-toggle">
          <span class="material-symbols-rounded">menu</span>
        </button>
        <img
          src="{{ url_for('static', filename='images/Civicsense.png') }}"
          alt="Civicsense AI Logo"
          class="mobile-header-logo"
        />
        <span style="width: 40px"></span>
      </div>

      <div class="main-content-inner">
        <div class="page-header">
          <div>
            <h1 class="page-title">
              <span class="material-symbols-rounded">report_problem</span>
              Report an Issue
            </h1>
            <p class="page-subtitle">
              Help us improve your city by reporting civic issues
            </p>
          </div>
          <div class="progress-indicator">
            <div class="progress-step">1</div>
            <span>Fill Details</span>
          </div>
        </div>

        <button id="scrollToTopBtn" title="Go to top">
          <span class="material-symbols-rounded">arrow_upward</span>
        </button>

        <div class="form-container">
          <form id="reportIssueForm">
            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <span class="material-symbols-rounded">person</span>
                </div>
                <h2 class="section-title">Personal Information</h2>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label for="fullName" class="form-label"
                    >Full Name <span class="required">*</span></label
                  >
                  <input
                    type="text"
                    class="form-input"
                    id="fullName"
                    name="fullName"
                    required
                  />
                  <div class="validation-message">
                    Please enter your full name.
                  </div>
                </div>
                <div class="form-group">
                  <label for="age" class="form-label"
                    >Age <span class="required">*</span></label
                  >
                  <input
                    type="number"
                    class="form-input"
                    id="age"
                    name="age"
                    min="1"
                    max="120"
                    required
                  />
                  <div class="validation-message">
                    Please enter a valid age.
                  </div>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label for="gender" class="form-label"
                    >Gender <span class="required">*</span></label
                  >
                  <select
                    class="form-select"
                    id="gender"
                    name="gender"
                    required
                  >
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                  </select>
                  <div class="validation-message">
                    Please select your gender.
                  </div>
                </div>
                <div class="form-group has-icon">
                  <label for="mobile" class="form-label"
                    >Mobile Number <span class="required">*</span></label
                  >
                  <input
                    type="tel"
                    class="form-input"
                    id="mobile"
                    name="mobile"
                    required
                  />
                  <span class="material-symbols-rounded input-icon">phone</span>
                  <div class="validation-message">
                    Please enter a valid mobile number.
                  </div>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group has-icon">
                  <label for="email" class="form-label"
                    >Email ID <span class="required">*</span></label
                  >
                  <input
                    type="email"
                    class="form-input"
                    id="email"
                    name="email"
                    required
                  />
                  <span class="material-symbols-rounded input-icon">email</span>
                  <div class="validation-message">
                    Please enter a valid email address.
                  </div>
                </div>
                <div class="form-group">
                  <label for="pincode" class="form-label"
                    >Pincode <span class="required">*</span></label
                  >
                  <input
                    type="text"
                    class="form-input"
                    id="pincode"
                    name="pincode"
                    required
                    maxlength="6"
                  />
                  <div class="validation-message" id="pincodeValidation">
                    Please enter a valid 6-digit pincode.
                  </div>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label for="city" class="form-label"
                    >Area <span class="required">*</span></label
                  >
                  <input
                    type="text"
                    class="form-input"
                    id="city"
                    name="city"
                    required
                  />
                  <div class="validation-message">
                    Please enter your city or town.
                  </div>
                </div>
                <div class="form-group">
                  <label for="district" class="form-label"
                    >District <span class="required">*</span></label
                  >
                  <input
                    type="text"
                    class="form-input"
                    id="district"
                    name="district"
                    required
                  />
                  <div class="validation-message">
                    Please enter your district.
                  </div>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label for="state" class="form-label"
                    >State <span class="required">*</span></label
                  >
                  <div id="stateWrapper"></div>
                  <div class="validation-message">
                    Please select your state.
                  </div>
                </div>
                <div class="form-group">
                  <label for="country" class="form-label"
                    >Country <span class="required">*</span></label
                  >
                  <select
                    class="form-select"
                    id="country"
                    name="country"
                    required
                  ></select>
                  <div class="validation-message">
                    Please select your country.
                  </div>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label for="residentialAddress" class="form-label"
                    >Residential Address <span class="required">*</span></label
                  >
                  <textarea
                    class="form-textarea"
                    id="residentialAddress"
                    name="residentialAddress"
                    required
                  ></textarea>
                  <div class="validation-message">
                    Please enter your residential address.
                  </div>
                </div>
                <div class="form-group">
                  <label for="workAddress" class="form-label"
                    >Work Address (Optional)</label
                  >
                  <textarea
                    class="form-textarea"
                    id="workAddress"
                    name="workAddress"
                  ></textarea>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <span class="material-symbols-rounded">bug_report</span>
                </div>
                <h2 class="section-title">Issue Details</h2>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label"
                    >Select Issue Category
                    <span class="required">*</span></label
                  >
                  <select
                    class="form-select"
                    id="issueCategory"
                    name="issueCategory"
                    required
                  >
                    <option value="">Select Category</option>
                    <option value="road-damage-potholes">
                      Road Damage & Potholes
                    </option>
                    <option value="street-cleaning">
                      Street Cleaning & Maintenance
                    </option>
                    <option value="garbage-overflow">
                      Garbage Overflow & Waste Disposal
                    </option>
                    <option value="waste-segregation">
                      Improper Waste Segregation
                    </option>
                    <option value="illegal-dumping">Illegal Dumping</option>
                    <option value="water-leakage">
                      Water Leakage & Pipe Burst
                    </option>
                    <option value="drinking-water">
                      Drinking Water Supply Issues
                    </option>
                    <option value="sewage-overflow">Sewage Overflow</option>
                    <option value="blocked-drains">
                      Blocked Drains & Manholes
                    </option>
                    <option value="open-drainage">Open Drainage Hazard</option>
                    <option value="power-outage">Power Outage</option>
                    <option value="street-light-not-working">
                      Street Light Not Functioning
                    </option>
                    <option value="electric-pole-damage">
                      Damaged or Broken Electric Poles
                    </option>
                    <option value="noise-pollution">
                      Noise Pollution Complaint
                    </option>
                    <option value="air-pollution">
                      Air Quality & Pollution Concern
                    </option>
                    <option value="construction-dust">
                      Construction Dust & Debris
                    </option>
                    <option value="unauthorized-construction">
                      Unauthorized Construction
                    </option>
                    <option value="land-encroachment">Land Encroachment</option>
                    <option value="pathway-encroachment">
                      Encroachment on Public Pathways
                    </option>
                    <option value="illegal-parking">Illegal Parking</option>
                    <option value="traffic-signal-issue">
                      Traffic Signal Malfunction
                    </option>
                    <option value="traffic-sign-damage">
                      Damaged Traffic Signs or Markings
                    </option>
                    <option value="broken-footpaths">
                      Broken Footpaths & Sidewalks
                    </option>
                    <option value="public-transport">
                      Public Transportation Complaints
                    </option>
                    <option value="overflowing-bins">
                      Overflowing Public Bins
                    </option>
                    <option value="public-restroom-issue">
                      Public Restroom Maintenance Issue
                    </option>
                    <option value="animal-menace">
                      Animal Menace (Stray Dogs, Cattle)
                    </option>
                    <option value="dead-animal">Dead Animal Removal</option>
                    <option value="tree-cutting">
                      Tree Cutting & Unauthorized Felling
                    </option>
                    <option value="tree-trimming">
                      Tree Trimming Required
                    </option>
                    <option value="park-maintenance">
                      Greenery & Park Maintenance
                    </option>
                    <option value="illegal-hoardings">
                      Illegal Hoardings & Posters
                    </option>
                    <option value="commercial-noise">
                      Noise from Commercial Establishments
                    </option>
                    <option value="vandalism">Vandalism & Graffiti</option>
                    <option value="community-safety">
                      Community Safety & Security Concern
                    </option>
                    <option value="speed-breaker">
                      Speed Breaker Request or Maintenance
                    </option>
                    <option value="damaged-public-fixtures">
                      Damaged Public Benches or Fixtures
                    </option>
                    <option value="stormwater-drainage">
                      Stormwater Drainage Issue
                    </option>
                    <option value="street-flooding">
                      Street Flooding After Rain
                    </option>
                    <option value="hazardous-waste">
                      Hazardous Waste Disposal
                    </option>
                    <option value="industrial-waste">
                      Industrial Waste Concern
                    </option>
                    <option value="plastic-waste">
                      Plastic Waste & Recycling Issue
                    </option>
                    <option value="street-signage">
                      Lack of Street Signage
                    </option>
                    <option value="water-contamination">
                      Water Contamination Complaint
                    </option>
                    <option value="mosquito-breeding">
                      Mosquito Breeding Grounds
                    </option>
                    <option value="open-manhole">Manhole Without Cover</option>
                    <option value="abandoned-vehicle">
                      Abandoned Vehicle Removal
                    </option>
                    <option value="public-lighting-request">
                      Public Lighting Installation Request
                    </option>
                    <option value="community-health">
                      Community Health & Sanitation Concern
                    </option>
                    <option value="others">
                      Other / General Civic Complaint
                    </option>
                  </select>
                  <div class="validation-message">
                    Please select an issue category
                  </div>
                  <div class="form-group custom-issue-input">
                    <label class="form-label"
                      >Please specify the issue type
                      <span class="required">*</span></label
                    >
                    <input
                      type="text"
                      class="form-input"
                      id="customIssueType"
                      name="customIssueType"
                    />
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label"
                    >Issue Summary / Description
                    <span class="required">*</span></label
                  >
                  <textarea
                    class="form-textarea"
                    id="issueDescription"
                    name="issueDescription"
                    required
                    placeholder="Please provide detailed description of the issue..."
                  ></textarea>
                  <div class="validation-message">
                    Please describe the issue in detail
                  </div>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <span class="material-symbols-rounded">photo_camera</span>
                </div>
                <h2 class="section-title">Attach Image</h2>
              </div>
              <div class="file-upload-area" id="fileUploadArea">
                <input
                  type="file"
                  class="file-input"
                  id="fileInput"
                  accept="image/*"
                  multiple
                />
                <div class="material-symbols-rounded upload-icon">
                  cloud_upload
                </div>
                <div class="upload-text">
                  Drag & drop images here or click to browse
                </div>
                <div class="upload-subtext">
                  Supported formats: JPG, PNG, GIF (Max 5MB each)
                </div>
                <div class="upload-buttons">
                  <button type="button" class="upload-btn" id="uploadBtn">
                    <span class="material-symbols-rounded">folder_open</span>
                    Choose Files
                  </button>
                </div>
              </div>
              <div class="file-preview" id="filePreview"></div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <span class="material-symbols-rounded">location_on</span>
                </div>
                <h2 class="section-title">
                  Issue Location <span class="required">*</span>
                </h2>
              </div>

              <div id="messageContainer"></div>

              <div class="location-options">
                <button type="button" class="location-btn" id="mapLocationBtn">
                  <span class="material-symbols-rounded">map</span>
                  Select on Map
                </button>

                <span
                  style="font-weight: 500; color: var(--color-text-secondary)"
                  >or</span
                >

                <button type="button" class="location-btn" id="gpsLocationBtn">
                  <span class="material-symbols-rounded">my_location</span>
                  Use Current Location
                </button>
              </div>

              <div class="search-container-with-icon">
                <span class="material-symbols-rounded search-icon">search</span>
                <input
                  type="text"
                  class="location-search"
                  id="locationSearch"
                  placeholder="Search for a location or address..."
                  autocomplete="off"
                />
              </div>

              <div class="map-container" id="mapContainer">
                <div class="map-loading">
                  <div class="loading-spinner"></div>
                  <p>Loading map...</p>
                </div>
                <div class="map-controls">
                  <button
                    type="button"
                    class="map-control-btn"
                    id="zoomInBtn"
                    title="Zoom In"
                  >
                    <span class="material-symbols-rounded">add</span>
                  </button>
                  <button
                    type="button"
                    class="map-control-btn"
                    id="zoomOutBtn"
                    title="Zoom Out"
                  >
                    <span class="material-symbols-rounded">remove</span>
                  </button>
                  <button
                    type="button"
                    class="map-control-btn"
                    id="centerMapBtn"
                    title="Center Map"
                  >
                    <span class="material-symbols-rounded"
                      >center_focus_strong</span
                    >
                  </button>
                </div>
              </div>

              <div class="location-info" id="locationInfo">
                <div class="location-address" id="locationAddress">
                  No location selected
                </div>
                <div class="location-coords" id="locationCoords">
                  Lat: -, Lng: -
                </div>
              </div>

              <input type="hidden" id="latitude" name="latitude" />
              <input type="hidden" id="longitude" name="longitude" />
              <input
                type="hidden"
                id="locationAddressInput"
                name="locationAddress"
              />
              <div class="validation-message" id="locationValidation">
                Please select the issue location
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <span class="material-symbols-rounded">priority_high</span>
                </div>
                <h2 class="section-title">
                  Priority Level <span class="required">*</span>
                </h2>
              </div>
              <div class="priority-options">
                <div class="priority-option">
                  <input
                    type="radio"
                    class="priority-radio"
                    id="critical"
                    name="priority"
                    value="critical"
                    required
                  />
                  <label for="critical" class="priority-label critical">
                    <span class="material-symbols-rounded">emergency</span>
                    Critical
                  </label>
                </div>
                <div class="priority-option">
                  <input
                    type="radio"
                    class="priority-radio"
                    id="normal"
                    name="priority"
                    value="normal"
                    required
                  />
                  <label for="normal" class="priority-label normal">
                    <span class="material-symbols-rounded">warning</span>
                    Normal
                  </label>
                </div>
                <div class="priority-option">
                  <input
                    type="radio"
                    class="priority-radio"
                    id="low"
                    name="priority"
                    value="low"
                    required
                  />
                  <label for="low" class="priority-label low">
                    <span class="material-symbols-rounded">info</span>
                    Low
                  </label>
                </div>
              </div>
              <div class="validation-message">
                Please select the priority level
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <div class="section-icon">
                  <span class="material-symbols-rounded">gavel</span>
                </div>
                <h2 class="section-title">
                  Declaration <span class="required">*</span>
                </h2>
              </div>

              <div class="consent-section">
                <div class="consent-checkbox">
                  <input
                    type="checkbox"
                    class="consent-input"
                    id="consent"
                    name="consent"
                    required
                  />
                  <label for="consent" class="consent-text">
                    I confirm that the above information is correct and give
                    consent to use this data for civic issue resolution. I
                    understand that this information will be processed according
                    to applicable privacy laws.
                  </label>
                </div>
                <div class="validation-message">
                  Please provide your consent to proceed
                </div>
              </div>
            </div>

            <div class="submit-section">
              <button type="button" class="reset-btn" id="resetBtn">
                <span class="material-symbols-rounded">refresh</span>
                Reset Form
              </button>
              <button type="submit" class="submit-btn" id="submitBtn">
                <span class="material-symbols-rounded">send</span>
                Submit
              </button>
            </div>

            <div class="success-message" id="successMessage">
              <span class="material-symbols-rounded">check_circle</span>
              <span
                >Issue reported successfully! You will receive updates via
                email</span
              >
            </div>
          </form>
        </div>
      </div>

      <footer class="footer-section">
        <div class="footer-content">
          <div class="footer-copyright">
            Copyright ¬© 2025 Civicsense AI. All rights reserved.
          </div>
          <div class="footer-developer">
            Developed by <a href="team-details">Team UNIQUE</a>
          </div>
        </div>
      </footer>
    </div>

    <div class="mobile-overlay"></div>

    <!-- MODIFIED: Success Modal now includes a place to show the Issue ID -->
    <div class="modal-overlay" id="successModalOverlay">
      <div class="modal-content">
        <div class="modal-icon">
          <span class="material-symbols-rounded">check_circle</span>
        </div>
        <h2 class="modal-title">Submitted!</h2>
        <p class="modal-message">
          Your issue has been reported successfully. Please save your Issue ID
          for future reference.
        </p>

        <!-- This container will display the unique ID from the server -->
        <div class="modal-issue-id-container">
          <div class="modal-issue-id-label">Your Issue ID is:</div>
          <div id="modal-issue-id"></div>
        </div>

        <button class="modal-button" id="modalOkayBtn">Okay</button>
      </div>
    </div>
    <script>
      // SCRIPT MODIFIED FOR PAGE NAVIGATION
      document.addEventListener("DOMContentLoaded", () => {
        // DOM Elements
        const sidebar = document.querySelector(".sidebar");
        const sidebarToggle = document.querySelector(".sidebar-toggle");
        const mobileToggle = document.querySelector(".mobile-toggle");
        const mobileOverlay = document.querySelector(".mobile-overlay");
        const themeToggle = document.querySelector(".theme-toggle");
        const themeIcon = themeToggle.querySelector(
          ".material-symbols-rounded"
        );
        const menuLinks = document.querySelectorAll(".menu-link");
        const logoutBtns = document.querySelectorAll(".logout-menu-link"); // Corrected selector

        // --- NEW: Function to set the active link based on the current page's URL ---
        const setActiveLink = () => {
          // Step 1: Get the current page's filename (e.g., "report-issue.html").
          const currentPage = window.location.pathname.split("/").pop();
          const activePage = currentPage === "" ? "index.html" : currentPage;

          // Step 2: Loop through every link in the sidebar.
          menuLinks.forEach((link) => {
            const linkPage = link.getAttribute("href");

            // Step 3: Always remove the 'active' class first to reset the state.
            link.classList.remove("active");

            // Step 4: If the link's href matches the current page, add the 'active' class back.
            // This is the part that makes the link appear highlighted.
            if (linkPage === activePage) {
              link.classList.add("active");
            }
          });
        };

        // Ensure you are still calling the function after defining it
        setActiveLink();
        // Theme Management
        const updateThemeIcon = () => {
          if (!themeIcon) return;
          const isDark = document.body.classList.contains("dark-theme");
          themeIcon.textContent = isDark ? "light_mode" : "dark_mode";
        };

        const savedTheme = localStorage.getItem("civicsense-theme");
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const shouldUseDarkTheme =
          savedTheme === "dark" || (!savedTheme && systemPrefersDark);

        if (shouldUseDarkTheme) {
          document.body.classList.add("dark-theme");
        }
        updateThemeIcon();

        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const isDark = document.body.classList.toggle("dark-theme");
            localStorage.setItem("civicsense-theme", isDark ? "dark" : "light");
            updateThemeIcon();
          });
        }

        // Desktop Sidebar Toggle
        if (sidebarToggle) {
          sidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("collapsed");
          });
        }

        // Mobile Menu Functionality
        if (mobileToggle) {
          mobileToggle.addEventListener("click", () => {
            sidebar.classList.toggle("open");
            mobileOverlay.classList.toggle("active");
          });
        }
        if (mobileOverlay) {
          mobileOverlay.addEventListener("click", () => {
            sidebar.classList.remove("open");
            mobileOverlay.classList.remove("active");
          });
        }

        // --- MODIFIED: Click handler only closes mobile menu, navigation is handled by browser
        menuLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            // Note: e.preventDefault() is intentionally removed to allow links to work.
            if (window.innerWidth <= 768) {
              sidebar.classList.remove("open");
              mobileOverlay.classList.remove("active");
            }
          });
        });

        // Logout Functionality
        if (logoutBtns.length) {
          logoutBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.preventDefault(); // Logout is an action, so we prevent navigation
              if (confirm("Are you sure you want to logout?")) {
                alert("Logging out...");
                // window.location.href = '/login.html';
              }
            });
          });
        }

        // --- START: Load Profile Picture into Sidebar ---
        async function loadSidebarProfilePic() {
          const sidebarPicElement =
            document.getElementById("sidebarProfilePic");
          if (!sidebarPicElement) return;

          try {
            const response = await fetch("/api/user/profile");
            if (!response.ok) return; // Fail silently if not logged in or error

            const data = await response.json();
            if (data.photo_url) {
              sidebarPicElement.src = data.photo_url;
            }
          } catch (error) {
            console.error("Could not load sidebar profile picture:", error);
          }
        }

        // Call the function to load the picture
        loadSidebarProfilePic();
        // --- END: Load Profile Picture into Sidebar ---

        // Resize handler
        const handleResize = () => {
          if (window.innerWidth > 768) {
            sidebar.classList.remove("collapsed"); // Keep it expanded on desktop
            sidebar.classList.remove("open");
            if (mobileOverlay) mobileOverlay.classList.remove("active");
          }
        };

        window.addEventListener("resize", handleResize);
        handleResize();

        console.log("Civicsense AI Dashboard Initialized.");
      });

      let uploadedFiles = [];
      let selectedLocation = null;

      // Google Maps Variables
      let map, marker, geocoder, autocomplete, infoWindow;
      let isMapLoaded = false;

      // --- NEW DATA FOR DYNAMIC FIELDS ---
      const indianStatesAndUTs = [
        "Andaman and Nicobar Islands",
        "Andhra Pradesh",
        "Arunachal Pradesh",
        "Assam",
        "Bihar",
        "Chandigarh",
        "Chhattisgarh",
        "Dadra and Nagar Haveli and Daman and Diu",
        "Delhi",
        "Goa",
        "Gujarat",
        "Haryana",
        "Himachal Pradesh",
        "Jammu and Kashmir",
        "Jharkhand",
        "Karnataka",
        "Kerala",
        "Ladakh",
        "Lakshadweep",
        "Madhya Pradesh",
        "Maharashtra",
        "Manipur",
        "Meghalaya",
        "Mizoram",
        "Nagaland",
        "Odisha",
        "Puducherry",
        "Punjab",
        "Rajasthan",
        "Sikkim",
        "Tamil Nadu",
        "Telangana",
        "Tripura",
        "Uttar Pradesh",
        "Uttarakhand",
        "West Bengal",
      ];

      const countries = ["India", "USA", "UK", "Canada", "Australia", "Other"]; // Add more countries as needed

      document.addEventListener("DOMContentLoaded", function () {
        initializeForm();
        // Load Google Maps API
        loadGoogleMapsAPI();

        // Add event listeners for buttons
        setupEventListeners();

        const successModalOverlay = document.getElementById(
          "successModalOverlay"
        );
        const modalOkayBtn = document.getElementById("modalOkayBtn");

        // ADD THIS EVENT LISTENER
        if (modalOkayBtn) {
          modalOkayBtn.addEventListener("click", () => {
            successModalOverlay.classList.remove("active");
          });
        }

        // ADD THIS EVENT LISTENER TO CLOSE MODAL ON OVERLAY CLICK
        if (successModalOverlay) {
          successModalOverlay.addEventListener("click", (event) => {
            // Checks if the click was on the overlay itself and not the content inside it
            if (event.target === successModalOverlay) {
              successModalOverlay.classList.remove("active");
            }
          });
        }
      });

      // --- START: Auto-scroll sidebar to active link ---
      const activeMenuLink = document.querySelector(
        ".sidebar .menu-link.active"
      );

      if (activeMenuLink) {
        // This function scrolls the sidebar so the active link is in the middle
        activeMenuLink.scrollIntoView({
          behavior: "smooth", // Optional: for a smooth scrolling animation
          block: "center", // This aligns the link to the center of the view
        });
      }
      // --- END: Auto-scroll sidebar to active link ---

      // ADD THIS NEW FUNCTION
      function resetForm() {
        const form = document.getElementById("reportIssueForm");
        form.reset();
        uploadedFiles = [];
        selectedLocation = null;
        document.getElementById("filePreview").innerHTML = "";
        document.getElementById("filePreview").style.display = "none";
        document.getElementById("locationInfo").classList.remove("active");
        document.getElementById("gpsLocationBtn").classList.remove("active");
        document.getElementById("mapLocationBtn").classList.remove("active");
        document
          .querySelectorAll(".validation-message")
          .forEach((msg) => (msg.style.display = "none"));
        document.getElementById("successMessage").style.display = "none";
        if (marker) marker.setMap(null);
        if (map) {
          map.setCenter({ lat: 13.0827, lng: 80.2707 });
          map.setZoom(15);
        }
        handleCountryChange(); // Resets the state dropdown
      }

      function initializeForm() {
        const form = document.getElementById("reportIssueForm");
        const issueCategorySelect = document.getElementById("issueCategory");
        const customIssueInput = document.querySelector(".custom-issue-input");
        const fileUploadArea = document.getElementById("fileUploadArea");
        const fileInput = document.getElementById("fileInput");
        const filePreview = document.getElementById("filePreview");
        const uploadBtn = document.getElementById("uploadBtn");
        const resetBtn = document.getElementById("resetBtn");
        const submitBtn = document.getElementById("submitBtn");
        const successMessage = document.getElementById("successMessage");

        // --- NEW CODE: Initialize address fields ---
        initializeAddressFields();

        // Dynamic issue field
        issueCategorySelect.addEventListener("change", function () {
          customIssueInput.style.display =
            this.value === "others" ? "block" : "none";
          document.getElementById("customIssueType").required =
            this.value === "others";
        });

        // File uploads
        fileUploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          fileUploadArea.classList.add("dragover");
        });

        fileUploadArea.addEventListener("dragleave", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
        });

        fileUploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
          processFiles([...e.dataTransfer.files]);
        });

        fileInput.addEventListener("change", (e) =>
          processFiles([...e.target.files])
        );

        uploadBtn.addEventListener("click", () => fileInput.click());

        // This is your existing event listener for the reset button
        resetBtn.addEventListener("click", () => {
          // It still asks for confirmation for manual clicks
          if (confirm("Reset the form?")) {
            resetForm(); // Calls the new function
          }
        });

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          if (!validateForm() || !validateLocation()) {
            showMessage(
              "Please fill all required fields and select a location.",
              "error"
            );
            return;
          }

          submitBtn.innerHTML = `<div class="loading-spinner"></div> Submitting...`;
          submitBtn.disabled = true;

          const formData = new FormData(form);
          uploadedFiles.forEach((file) => {
            formData.append("files[]", file, file.name);
          });

          // We need to get the modal elements here again to be safe
          const successModalOverlay = document.getElementById(
            "successModalOverlay"
          );
          const modalIssueIdElement = document.getElementById("modal-issue-id");

          fetch("/report-issue", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success" && data.issueId) {
                // Set the issue ID in the modal
                modalIssueIdElement.textContent = data.issueId;
                // Show the modal
                successModalOverlay.classList.add("active");
              } else {
                showMessage(
                  data.message || "An error occurred on the server.",
                  "error"
                );
              }
            })
            .catch((error) => {
              console.error("Submission Error:", error);
              showMessage(
                "Could not connect to the server. Please try again later.",
                "error"
              );
            })
            .finally(() => {
              submitBtn.innerHTML = `<span class="material-symbols-rounded">send</span> Submit`;
              submitBtn.disabled = false;
            });
        });
        // This listener for the "Okay" button now simply closes the modal and resets the form.
        modalOkayBtn.addEventListener("click", () => {
          successModalOverlay.classList.remove("active");
          resetForm(); // Assuming your detailed resetForm function exists
        });

        document
          .getElementById("mobile")
          .addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/\D/g, "").slice(0, 10);
          });

        document.getElementById("email").addEventListener("blur", function (e) {
          const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          const msg = e.target.parentElement.querySelector(
            ".validation-message"
          );
          if (e.target.value && !regex.test(e.target.value)) {
            msg.textContent = "Please enter a valid email address";
            msg.style.display = "block";
          } else {
            msg.style.display = "none";
          }
        });
      }

      // --- NEW FUNCTION: To setup pincode, country, and state fields ---
      function initializeAddressFields() {
        const pincodeInput = document.getElementById("pincode");
        const countrySelect = document.getElementById("country");

        // Populate country dropdown
        countries.forEach((country) => {
          const option = document.createElement("option");
          option.value = country;
          option.textContent = country;
          if (country === "India") {
            option.selected = true;
          }
          countrySelect.appendChild(option);
        });

        // Set initial state field (for India by default)
        handleCountryChange();

        // Add event listeners
        countrySelect.addEventListener("change", handleCountryChange);
        pincodeInput.addEventListener("input", handlePincodeInput);
      }

      // --- NEW FUNCTION: To handle dynamic state field based on country ---
      function handleCountryChange() {
        const countrySelect = document.getElementById("country");
        const stateWrapper = document.getElementById("stateWrapper");
        const selectedCountry = countrySelect.value;
        stateWrapper.innerHTML = ""; // Clear previous content

        if (selectedCountry === "India") {
          // Create a dropdown for Indian states
          const stateSelect = document.createElement("select");
          stateSelect.id = "state";
          stateSelect.name = "state";
          stateSelect.className = "form-select";
          stateSelect.required = true;

          // Add a placeholder option
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "Select State";
          stateSelect.appendChild(placeholder);

          // Populate with states
          indianStatesAndUTs.forEach((stateName) => {
            const option = document.createElement("option");
            option.value = stateName;
            option.textContent = stateName;
            stateSelect.appendChild(option);
          });
          stateWrapper.appendChild(stateSelect);
        } else {
          // Create a text input for other countries
          const stateInput = document.createElement("input");
          stateInput.type = "text";
          stateInput.id = "state";
          stateInput.name = "state";
          stateInput.className = "form-input";
          stateInput.placeholder = "Enter state/province";
          stateInput.required = true;
          stateWrapper.appendChild(stateInput);
        }
      }

      // --- NEW FUNCTION: To fetch address details from pincode ---
      async function handlePincodeInput(event) {
        const pincode = event.target.value;
        const validationMsg = document.getElementById("pincodeValidation");

        // Only trigger API call for 6-digit pincodes
        if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
          validationMsg.style.display = "none";
          try {
            const response = await fetch(
              `https://api.postalpincode.in/pincode/${pincode}`
            );
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            const data = await response.json();

            if (data && data[0].Status === "Success") {
              const postOffice = data[0].PostOffice[0];
              // Autofill fields
              document.getElementById("city").value = postOffice.Block;
              document.getElementById("district").value = postOffice.District;
              document.getElementById("country").value = "India";
              // Trigger country change to ensure state dropdown is correct
              handleCountryChange();
              // A short delay to allow the state dropdown to be created before setting its value
              setTimeout(() => {
                document.getElementById("state").value = postOffice.State;
              }, 100);
            } else {
              validationMsg.textContent = "Invalid pincode. Please try again.";
              validationMsg.style.display = "block";
            }
          } catch (error) {
            console.error("Pincode API Error:", error);
            validationMsg.textContent =
              "Could not fetch pincode details. Please enter manually.";
            validationMsg.style.display = "block";
          }
        }
      }

      function processFiles(files) {
        const previewContainer = document.getElementById("filePreview");
        files.forEach((file) => {
          if (file.type.startsWith("image/") && file.size <= 5 * 1024 * 1024) {
            uploadedFiles.push(file);
            const div = document.createElement("div");
            div.className = "preview-item";
            div.innerHTML = `
          <img class="preview-image" src="${URL.createObjectURL(
            file
          )}" alt="Preview">
          <div class="preview-info">
            <div class="preview-name">${file.name}</div>
            <div class="preview-size">${(file.size / 1024).toFixed(1)} KB</div>
          </div>
          <button type="button" class="remove-file" onclick="removeFile('${
            file.name
          }')">
            <span class="material-symbols-rounded">close</span>
          </button>`;
            previewContainer.appendChild(div);
            previewContainer.style.display = "block";
          } else {
            alert("Only image files under 5MB allowed.");
          }
        });
      }

      function removeFile(fileName) {
        uploadedFiles = uploadedFiles.filter((f) => f.name !== fileName);
        document.getElementById("filePreview").innerHTML = "";
        uploadedFiles.forEach(processFiles);
      }

      function validateForm() {
        const form = document.getElementById("reportIssueForm");
        const requiredFields = form.querySelectorAll("[required]");
        let isFormValid = true;

        requiredFields.forEach((field) => {
          let msg;
          // Use a more robust method to find the validation message based on the field's container
          if (field.name === "priority" || field.name === "consent") {
            // For Priority and Consent, find the message within the parent .form-section
            msg = field
              .closest(".form-section")
              .querySelector(".validation-message");
          } else {
            // For standard fields, find the message within their .form-group
            msg = field
              .closest(".form-group")
              ?.querySelector(".validation-message");
          }

          let fieldIsValid = false;

          // Check validation based on the input type
          if (field.type === "radio") {
            const radioGroup = document.querySelectorAll(
              `input[name="${field.name}"]`
            );
            if ([...radioGroup].some((radio) => radio.checked)) {
              fieldIsValid = true;
            }
          } else if (field.type === "checkbox") {
            if (field.checked) {
              fieldIsValid = true;
            }
          } else {
            // Default check for text, select, textarea, etc.
            if (field.value.trim() !== "") {
              fieldIsValid = true;
            }
          }

          // Show or hide the validation message
          if (fieldIsValid) {
            if (msg) msg.style.display = "none";
          } else {
            if (msg) msg.style.display = "block";
            isFormValid = false;
          }
        });

        return isFormValid;
      }
      function loadGoogleMapsAPI() {
        // Check if Google Maps is already loaded
        if (window.google && window.google.maps) {
          initializeGoogleMaps();
          return;
        }

        // Create script element for Google Maps API
        const script = document.createElement("script");
        script.src =
          "https://maps.googleapis.com/maps/api/js?key=AIzaSyCDgvBDfYBO3SyzvGMkuN3R8vLvur78Oi4&libraries=places&callback=initializeGoogleMaps";
        script.async = true;
        script.defer = true;

        // Handle script loading errors
        script.onerror = function () {
          showMessage(
            "Failed to load Google Maps. Please check your internet connection and try again.",
            "error"
          );
        };

        document.head.appendChild(script);
      }

      function initializeGoogleMaps() {
        try {
          // Default location - Chennai, Tamil Nadu
          const defaultLoc = { lat: 13.0827, lng: 80.2707 };

          // Clear loading message
          document.getElementById("mapContainer").innerHTML = "";

          // Initialize map
          map = new google.maps.Map(document.getElementById("mapContainer"), {
            center: defaultLoc,
            zoom: 15,
            mapTypeId: "roadmap",
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: false,
            gestureHandling: "cooperative",
          });

          // Re-add map controls after map initialization
          const mapControls = document.createElement("div");
          mapControls.className = "map-controls";
          mapControls.innerHTML = `
                    <button type="button" class="map-control-btn" id="zoomInBtn" title="Zoom In">
                        <span class="material-symbols-rounded">add</span>
                    </button>
                    <button type="button" class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                        <span class="material-symbols-rounded">remove</span>
                    </button>
                    <button type="button" class="map-control-btn" id="centerMapBtn" title="Center Map">
                        <span class="material-symbols-rounded">center_focus_strong</span>
                    </button>
                `;
          document.getElementById("mapContainer").appendChild(mapControls);

          // Initialize geocoder and info window
          geocoder = new google.maps.Geocoder();
          infoWindow = new google.maps.InfoWindow();

          // Initialize autocomplete for search
          const searchInput = document.getElementById("locationSearch");
          autocomplete = new google.maps.places.Autocomplete(searchInput, {
            types: ["geocode"],
            componentRestrictions: { country: "IN" },
          });

          // Handle autocomplete place selection
          autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.geometry && place.geometry.location) {
              map.setCenter(place.geometry.location);
              map.setZoom(17);
              setLocationMarker(place.geometry.location);
              showMessage("Location selected from search", "success");
            }
          });

          // Handle map click to set location
          map.addListener("click", (event) => {
            setLocationMarker(event.latLng);
            showMessage("Location selected on map", "success");
          });

          // Setup map control events
          setupMapControls();

          isMapLoaded = true;
          showMessage("Map loaded successfully", "success");
        } catch (error) {
          console.error("Error initializing Google Maps:", error);
          showMessage(
            "Error initializing map. Please refresh the page and try again.",
            "error"
          );
        }
      }

      function setupEventListeners() {
        // Location option buttons
        const mapBtn = document.getElementById("mapLocationBtn");
        const gpsBtn = document.getElementById("gpsLocationBtn");

        if (mapBtn) {
          mapBtn.addEventListener("click", handleMapLocation);
        }

        if (gpsBtn) {
          gpsBtn.addEventListener("click", handleGpsLocation);
        }
      }

      function setupMapControls() {
        // Map control buttons
        const zoomInBtn = document.getElementById("zoomInBtn");
        const zoomOutBtn = document.getElementById("zoomOutBtn");
        const centerBtn = document.getElementById("centerMapBtn");

        if (zoomInBtn) {
          zoomInBtn.addEventListener("click", () => {
            if (map) map.setZoom(map.getZoom() + 1);
          });
        }

        if (zoomOutBtn) {
          zoomOutBtn.addEventListener("click", () => {
            if (map) map.setZoom(map.getZoom() - 1);
          });
        }

        if (centerBtn) {
          centerBtn.addEventListener("click", () => {
            if (map) {
              map.setCenter(selectedLocation || { lat: 13.0827, lng: 80.2707 });
            }
          });
        }
      }

      function setLocationMarker(location) {
        if (!map) return;

        try {
          // Remove existing marker if any
          if (marker) {
            marker.setMap(null);
          }

          // Create new marker
          marker = new google.maps.Marker({
            map: map,
            position: location,
            animation: google.maps.Animation.DROP,
            title: "Issue Location",
          });

          // Store selected location
          selectedLocation = {
            lat: location.lat(),
            lng: location.lng(),
          };

          // Update hidden form inputs
          document.getElementById("latitude").value = selectedLocation.lat;
          document.getElementById("longitude").value = selectedLocation.lng;

          // Reverse geocode to get address
          geocoder.geocode({ location: location }, (results, status) => {
            if (status === "OK" && results[0]) {
              const address = results[0].formatted_address;
              document.getElementById("locationAddressInput").value = address;
              updateLocationInfo(address, selectedLocation);

              // Show info window
              infoWindow.setContent(`
                            <div style="padding: 8px; font-family: Poppins, sans-serif;">
                                <strong>Issue Location</strong><br>
                                <span style="color: #666; font-size: 0.9rem;">${address}</span>
                            </div>
                        `);
              infoWindow.open(map, marker);
            } else {
              // Fallback if geocoding fails
              const fallbackAddress = `Location: ${selectedLocation.lat.toFixed(
                6
              )}, ${selectedLocation.lng.toFixed(6)}`;
              document.getElementById("locationAddressInput").value =
                fallbackAddress;
              updateLocationInfo(fallbackAddress, selectedLocation);

              infoWindow.setContent(`
                            <div style="padding: 8px; font-family: Poppins, sans-serif;">
                                <strong>Issue Location</strong><br>
                                <span style="color: #666; font-size: 0.9rem;">${fallbackAddress}</span>
                            </div>
                        `);
              infoWindow.open(map, marker);
            }
          });

          // Hide validation message
          document.getElementById("locationValidation").style.display = "none";
        } catch (error) {
          console.error("Error setting location marker:", error);
          showMessage("Error setting location marker", "error");
        }
      }

      function updateLocationInfo(address, coords) {
        const infoBox = document.getElementById("locationInfo");
        const addressElement = document.getElementById("locationAddress");
        const coordsElement = document.getElementById("locationCoords");

        if (addressElement) addressElement.textContent = address;
        if (coordsElement)
          coordsElement.textContent = `Lat: ${coords.lat.toFixed(
            6
          )}, Lng: ${coords.lng.toFixed(6)}`;
        if (infoBox) infoBox.classList.add("active");
      }

      function handleMapLocation() {
        if (!isMapLoaded) {
          showMessage("Please wait for the map to load", "error");
          return;
        }

        // Activate map location button
        document.getElementById("mapLocationBtn").classList.add("active");
        document.getElementById("gpsLocationBtn").classList.remove("active");

        // If no location selected, center on default location
        if (!selectedLocation && map) {
          map.setCenter({ lat: 13.0827, lng: 80.2707 });
          map.setZoom(15);
        }

        showMessage("Click on the map to select location", "success");
      }

      function handleGpsLocation() {
        if (!isMapLoaded) {
          showMessage("Please wait for the map to load", "error");
          return;
        }

        const gpsBtn = document.getElementById("gpsLocationBtn");

        // Activate GPS location button
        gpsBtn.classList.add("active");
        document.getElementById("mapLocationBtn").classList.remove("active");

        // Check if geolocation is supported
        if (!navigator.geolocation) {
          showMessage("Geolocation is not supported by this browser", "error");
          return;
        }

        // Show loading state
        gpsBtn.innerHTML = `<div class="loading-spinner"></div> Getting Location...`;
        gpsBtn.disabled = true;

        // Get current position
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // Center map on current location
            if (map) {
              map.setCenter(currentLocation);
              map.setZoom(17);

              // Set marker at current location
              setLocationMarker(
                new google.maps.LatLng(currentLocation.lat, currentLocation.lng)
              );

              showMessage("Current location detected successfully", "success");
            }

            // Reset button
            resetGpsButton();
          },
          (error) => {
            // Handle geolocation error
            console.error("Geolocation error:", error);
            let errorMessage = "Unable to get your current location. ";

            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage += "Please allow location access and try again.";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage += "Location information is unavailable.";
                break;
              case error.TIMEOUT:
                errorMessage += "Location request timed out.";
                break;
              default:
                errorMessage += "Please try again or select location manually.";
                break;
            }

            showMessage(errorMessage, "error");
            resetGpsButton();
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000, // 5 minutes
          }
        );
      }

      function resetGpsButton() {
        const gpsBtn = document.getElementById("gpsLocationBtn");
        gpsBtn.innerHTML = `<span class="material-symbols-rounded">my_location</span> Use Current Location`;
        gpsBtn.disabled = false;
      }

      function showMessage(message, type) {
        const messageContainer = document.getElementById("messageContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className =
          type === "error" ? "error-message" : "success-message";
        messageDiv.textContent = message;

        // Clear existing messages
        messageContainer.innerHTML = "";
        messageContainer.appendChild(messageDiv);

        // Auto-hide success messages after 3 seconds
        if (type === "success") {
          setTimeout(() => {
            if (messageDiv.parentNode) {
              messageDiv.parentNode.removeChild(messageDiv);
            }
          }, 3000);
        }
      }

      // Utility functions for form integration
      function validateLocation() {
        if (!selectedLocation) {
          document.getElementById("locationValidation").style.display = "block";
          showMessage("Please select the issue location", "error");
          return false;
        }
        return true;
      }

      function resetLocation() {
        selectedLocation = null;
        if (marker) {
          marker.setMap(null);
          marker = null;
        }
        document.getElementById("latitude").value = "";
        document.getElementById("longitude").value = "";
        document.getElementById("locationAddressInput").value = "";
        document.getElementById("locationInfo").classList.remove("active");
        document.getElementById("mapLocationBtn").classList.remove("active");
        document.getElementById("gpsLocationBtn").classList.remove("active");
        document.getElementById("locationSearch").value = "";
        document.getElementById("messageContainer").innerHTML = "";

        if (map) {
          map.setCenter({ lat: 13.0827, lng: 80.2707 });
          map.setZoom(15);
        }

        if (infoWindow) {
          infoWindow.close();
        }
      }

      // --- NEW: Scroll to Top Button Logic ---
      const scrollToTopBtn = document.getElementById("scrollToTopBtn");

      // Show or hide the button based on scroll position
      window.addEventListener("scroll", () => {
        if (window.scrollY > 300) {
          // Show button if scrolled more than 300px
          scrollToTopBtn.style.display = "flex";
          setTimeout(() => scrollToTopBtn.classList.add("visible"), 10);
        } else {
          // Hide button
          scrollToTopBtn.classList.remove("visible");
          // Optional: Hide completely after transition
          setTimeout(() => {
            if (!scrollToTopBtn.classList.contains("visible")) {
              scrollToTopBtn.style.display = "none";
            }
          }, 300);
        }
      });

      // Scroll to the top when the button is clicked
      scrollToTopBtn.addEventListener("click", () => {
        window.scrollTo({
          top: 0,
          behavior: "smooth", // For a smooth scrolling effect
        });
      });

      // Make functions available globally for form integration
      window.validateLocation = validateLocation;
      window.resetLocation = resetLocation;
      window.initializeGoogleMaps = initializeGoogleMaps;
    </script>
  </body>
</html>
