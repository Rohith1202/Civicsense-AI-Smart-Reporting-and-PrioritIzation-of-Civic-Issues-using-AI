<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Civicsense AI</title>
    <!-- Importing Google Fonts - Poppins -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    />
    <!-- Google Material Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='images/favicon.png') }}"
    />

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      :root {
        /* Light theme colors */
        --color-text-primary: #1f2936;
        --color-text-secondary: #64748b;
        --color-text-placeholder: #798eae;
        --color-bg-primary: #f8fafc;
        --color-bg-secondary: #e2e8f0;
        --color-bg-sidebar: #ffffff;
        --color-border-hr: #e2e8f0;
        --color-hover-primary: #3b82f6;
        --color-hover-secondary: #f1f5f9;
        --color-accent: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-shadow: rgba(0, 0, 0, 0.08);
        --color-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --sidebar-width: 280px;
        --sidebar-collapsed-width: 80px;
        --header-height: 70px;
      }

      body.dark-theme {
        /* Dark theme colors */
        --color-text-primary: #f1f5f9;
        --color-text-secondary: #94a3b8;
        --color-text-placeholder: #a6b7d2;
        --color-bg-primary: #0f172a;
        --color-bg-secondary: #1e293b;
        --color-bg-sidebar: #1e293b;
        --color-border-hr: #334155;
        --color-hover-primary: #3b82f6;
        --color-hover-secondary: #334155;
        --color-accent: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-shadow: rgba(0, 0, 0, 0.3);
        --color-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      body {
        min-height: 100vh;
        background: var(--color-bg-primary);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      /* Header Styles */
      .main-header {
        position: fixed;
        top: 0;
        left: var(--sidebar-width);
        right: 0;
        height: var(--header-height);
        background: white;
        border-bottom: 1px solid var(--color-border-hr);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 0 30px;
        z-index: 999;
        transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      body.dark-theme .main-header {
        background: var(--color-bg-sidebar);
        border-bottom-color: var(--color-border-hr);
      }

      /* ADD THIS CSS */
      .main-header {
        /* Modify existing header to space out items */
        justify-content: space-between;
      }

      .header-search-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 400px;
      }

      .header-search-container .search-icon {
        position: absolute;
        left: 15px;
        color: var(--color-text-placeholder);
        font-size: 1.3rem;
        pointer-events: none; /* Allows clicking through the icon */
      }

      #headerSearchInput {
        width: 100%;
        height: 42px;
        border-radius: 12px;
        border: 1px solid var(--color-border-hr);
        background-color: var(--color-bg-primary);
        color: var(--color-text-primary);
        padding: 0 15px 0 45px; /* Right padding for text, left for icon */
        font-size: 0.95rem;
        outline: none;
        transition: all 0.3s ease;
      }

      #headerSearchInput:focus {
        border-color: var(--color-hover-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      #headerSearchInput::placeholder {
        color: var(--color-text-placeholder);
      }

      .profile-dropdown {
        position: relative;
      }

      .profile-trigger {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        border: none;
        background: none;
      }

      .profile-trigger:hover {
        background: var(--color-hover-secondary);
      }

      .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--color-border-hr);
        background-color: var(--color-bg-secondary);
      }

      .profile-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
      }

      .profile-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--color-text-primary);
        line-height: 1.2;
      }

      .profile-role {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        line-height: 1.2;
      }

      .profile-dropdown-icon {
        color: var(--color-text-secondary);
        font-size: 1.2rem;
        transition: transform 0.3s ease;
      }

      .profile-trigger.active .profile-dropdown-icon {
        transform: rotate(180deg);
      }

      .profile-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--color-bg-sidebar);
        border: 1px solid var(--color-border-hr);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .profile-dropdown-menu.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .profile-dropdown-menu .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: var(--color-text-primary);
        text-decoration: none;
        transition: background-color 0.3s ease;
        border-radius: 8px;
        margin: 4px;
      }

      .profile-dropdown-menu .dropdown-item:hover {
        background: var(--color-hover-secondary);
      }

      .profile-dropdown-menu .dropdown-item.logout {
        color: var(--color-error);
        border-top: 1px solid var(--color-border-hr);
        margin-top: 8px;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--color-bg-sidebar);
        border-right: 1px solid var(--color-border-hr);
        box-shadow: 0 4px 20px var(--color-shadow);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
      }

      .sidebar-header {
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--color-border-hr);
        background: white;
        color: #0d47a1;
        position: relative;
      }

      .header-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        transition: opacity 0.4s ease;
      }

      .header-logo {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .header-title {
        font-size: 1.2rem;
        font-weight: 600;
        transition: opacity 0.4s ease;
      }

      .centered-logo {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .logo-img {
        height: 100px;
        width: auto;
        object-fit: contain;
      }

      .sidebar-toggle {
        height: 36px;
        width: 36px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: white;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .sidebar-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .sidebar-toggle span {
        font-size: 1.4rem;
        transition: transform 0.4s ease;
      }

      .sidebar-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--color-text-placeholder) transparent;
      }

      .sidebar-content::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .sidebar-content::-webkit-scrollbar-thumb {
        background: var(--color-text-placeholder);
        border-radius: 3px;
      }

      .menu-section-title {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
        padding: 0 12px;
        transition: opacity 0.3s ease;
      }

      .menu-list {
        display: flex;
        gap: 4px;
        list-style: none;
        flex-direction: column;
      }

      .menu-link {
        display: flex;
        gap: 12px;
        white-space: nowrap;
        border-radius: 12px;
        padding: 12px 16px;
        align-items: center;
        text-decoration: none;
        color: var(--color-text-primary);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .menu-link::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background: var(--color-hover-primary);
      }

      .menu-icon,
      .menu-label {
        position: relative;
        z-index: 2;
      }

      .menu-link.active {
        color: white;
      }

      .menu-link.active::before {
        width: 100%;
      }

      .menu-link:not(.logout-menu-link):not(.active):hover {
        background-color: var(--color-hover-secondary);
      }

      .menu-link .menu-icon {
        font-size: 1.3rem;
        min-width: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .menu-label {
        font-size: 0.95rem;
        font-weight: 500;
        transition: opacity 0.3s ease;
      }

      .status-badge {
        background: var(--color-accent);
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: auto;
        font-weight: 500;
      }

      .divider {
        height: 1px;
        background: var(--color-border-hr);
        margin: 16px 0;
      }

      .sidebar-footer {
        padding: 20px;
        border-top: 1px solid var(--color-border-hr);
        background: var(--color-bg-secondary);
      }

      .theme-toggle {
        width: 100%;
        min-height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        cursor: pointer;
        border: none;
        padding: 0 16px;
        color: var(--color-text-primary);
        background: var(--color-bg-sidebar);
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: var(--color-hover-secondary);
      }

      .theme-label {
        display: flex;
        gap: 12px;
        align-items: center;
        flex: 1;
      }

      .theme-text {
        font-size: 0.95rem;
        font-weight: 500;
        transition: opacity 0.3s ease;
      }

      .theme-toggle-track {
        height: 24px;
        width: 48px;
        border-radius: 999px;
        background: var(--color-bg-secondary);
        position: relative;
        transition: all 0.3s ease;
      }

      body.dark-theme .theme-toggle-track {
        background: var(--color-hover-primary);
      }

      .theme-toggle-indicator {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      body.dark-theme .theme-toggle-indicator {
        transform: translateX(24px);
      }

      .main-content {
        margin-left: var(--sidebar-width);
        margin-top: var(--header-height);
        min-height: calc(100vh - var(--header-height));
        display: flex;
        flex-direction: column;
        transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .main-content-inner {
        flex: 1;
        padding: 30px;
        color: var(--color-text-primary);
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin: 0;
      }

      .page-subtitle {
        font-size: 1.1rem;
        color: var(--color-text-secondary);
        margin-top: 8px;
      }

      .status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      /* NEW & IMPROVED CSS */
      .status-card {
        background: var(--color-bg-sidebar);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 12px var(--color-shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 5px solid transparent; /* Base for the colored line */
      }

      .status-card:hover {
        box-shadow: 0 8px 25px var(--color-shadow);
        transform: translateY(-5px); /* Creates the "lift" effect */
      }

      /* New classes for the colored borders */
      .card-submissions {
        border-left-color: var(--color-hover-primary);
      }
      .card-pending {
        border-left-color: var(--color-warning);
      }
      .card-progress {
        border-left-color: #ec4899; /* Changed to a vibrant pink */
      }
      .card-resolved {
        border-left-color: #10b981;
      }
      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: white;
      }

      .card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 8px;
      }

      .card-description {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }

      .loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .loading .card-value::after {
        content: "";
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--color-border-hr);
        border-top: 2px solid var(--color-hover-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .recent-submissions-table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
      }

      .recent-submissions-table th {
        padding: 12px;
        text-align: left;
        color: var(--color-text-secondary);
        font-weight: 600;
        border-bottom: 2px solid var(--color-border-hr);
      }

      .recent-submissions-table td {
        padding: 12px;
        border-bottom: 1px solid var(--color-border-hr);
      }

      .status-badge-table {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-submitted {
        background: #e0f2fe;
        color: #0277bd;
      }
      .status-in-progress {
        background: #fff3e0;
        color: #ef6c00;
      }
      .status-resolved {
        background: #e8f5e8;
        color: #2e7d32;
      }
      .status-rejected {
        background: #ffebee;
        color: #c62828;
      }

      .logout-menu-link {
        color: var(--color-error) !important;
      }

      .logout-menu-link::before {
        display: none !important;
      }

      .logout-menu-link:hover,
      .logout-menu-link.active,
      .profile-dropdown-menu .dropdown-item.logout:hover {
        background: rgba(
          239,
          68,
          68,
          0.1
        ) !important; /* NEW: Very light red background */
        color: var(--color-error) !important; /* Solid red text */
        font-weight: 600;
      }

      .footer-section {
        background: var(--color-bg-secondary);
        border-top: 1px solid var(--color-border-hr);
        margin-top: auto;
        padding: 10px 0;
        transition: all 0.3s ease;
      }

      .footer-content {
        display: flex;
        flex-direction: column;
        text-align: center;
        justify-content: space-between;
        padding: 16px 24px;
        gap: 12px;
      }

      .footer-copyright {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
      }

      .footer-developer {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
      }

      .footer-developer a {
        color: #0d47a1;
        font-weight: bold;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .footer-developer a:hover {
        color: var(--color-hover-primary);
      }

      @media (min-width: 768px) {
        .footer-content {
          flex-direction: row;
          text-align: left;
        }
      }

      .sidebar-profile-pic {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--color-border-hr);
        background-color: var(--color-bg-secondary);
      }

      .dark-mode-logo {
        display: none;
      }

      body.dark-theme .sidebar-header {
        background: var(--color-bg-sidebar);
      }

      body.dark-theme .light-mode-logo {
        display: none;
      }

      body.dark-theme .dark-mode-logo {
        display: block;
        margin: 0 auto;
        transform: translateX(10px);
      }

      .light-mode-logo {
        display: block;
        margin: 0 auto;
      }

      /* Mobile responsive */
      @media (max-width: 768px) {
        .main-header {
          left: 0;
          padding: 0 16px;
        }

        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .mobile-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
          opacity: 1;
          pointer-events: auto;
        }

        .mobile-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px 20px;
          background: var(--color-bg-sidebar);
          border-bottom: 1px solid var(--color-border-hr);
          position: sticky;
          top: 0;
          z-index: 100;
        }

        .mobile-toggle {
          background: none;
          border: none;
          font-size: 1.5rem;
          color: var(--color-text-primary);
          cursor: pointer;
        }

        .status-cards {
          grid-template-columns: 1fr;
        }

        .main-content-inner {
          padding: 20px;
        }
      }

      /* ADD THIS CSS FOR PAGINATION */
      .pagination-container {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--color-border-hr);
      }

      .pagination-button {
        border: 1px solid var(--color-border-hr);
        background-color: var(--color-bg-sidebar);
        color: var(--color-text-secondary);
        border-radius: 8px;
        padding: 8px 14px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .pagination-button:hover {
        background-color: var(--color-hover-secondary);
        color: var(--color-text-primary);
      }

      .pagination-button.active {
        background-color: var(--color-hover-primary);
        color: #fff;
        border-color: var(--color-hover-primary);
      }

      .pagination-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ADD THIS CSS */
      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap; /* Helps on smaller screens */
        gap: 20px;
      }

      #currentDate {
        color: var(--color-text-secondary);
        font-weight: 500;
      }

      .header-cta-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: var(--color-hover-primary);
        color: #fff;
        padding: 12px 20px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
      }

      .header-cta-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
      }

      /* ADD THIS CSS for the new notification feature */

      .header-actions-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .notification-dropdown {
        position: relative;
      }

      .notification-trigger {
        position: relative;
        background: none;
        border: none;
        color: var(--color-text-secondary);
        font-size: 1.6rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .notification-trigger:hover {
        background-color: var(--color-hover-secondary);
      }

      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background-color: var(--color-error);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--color-bg-sidebar);
        transform: scale(0);
        transition: transform 0.2s ease-out;
      }

      .notification-badge.visible {
        transform: scale(1);
      }

      .notification-menu {
        position: absolute;
        top: 120%; /* Position below the icon */
        right: 0;
        background: var(--color-bg-sidebar);
        border: 1px solid var(--color-border-hr);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        width: 380px;
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .notification-menu.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .notification-menu-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--color-border-hr);
      }
      .notification-menu-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text-primary); /* <-- ADD THIS LINE */
      }

      .notification-menu-body {
        padding: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
      }
      .notification-menu-body::-webkit-scrollbar {
        width: 6px;
      }
      .notification-menu-body::-webkit-scrollbar-track {
        background: transparent;
      }
      .notification-menu-body::-webkit-scrollbar-thumb {
        background-color: var(--color-bg-secondary);
        border-radius: 10px;
      }

      .notification-item {
        padding: 1rem 1rem;
        border-radius: 8px;
        margin: 0.5rem;
      }
      .notification-item:hover {
        background-color: var(--color-hover-secondary);
      }

      .notification-title {
        display: flex;
        align-items: center;
        gap: 8px; /* Space between icon and title */
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
        color: var(--color-text-primary);
      }

      .notification-title .admin-icon {
        font-size: 1.2rem;
        color: var(--color-hover-primary); /* Use a theme color for the icon */
      }
      /* ADD THIS RULE for the announcement dividers */
      .notification-item:not(:last-child) {
        border-bottom: 1px solid var(--color-border-hr);
        padding-bottom: 1.25rem; /* Adds some space below the content */
        margin-bottom: 0.5rem;
      }

      .notification-content {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        line-height: 1.6;
        white-space: pre-wrap;
      }

      .notification-date {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-bottom: 0.5rem; /* Change margin-top to margin-bottom */
        opacity: 0.7;
      }
      .no-notifications {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--color-text-secondary);
      }
      .no-notifications .material-symbols-rounded {
        font-size: 3rem;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="main-header">
      <div class="header-search-container">
        <span class="material-symbols-rounded search-icon">search</span>
        <input
          type="text"
          id="headerSearchInput"
          placeholder="Search submissions..."
        />
      </div>

      <div class="header-actions-right">
        <div class="notification-dropdown">
          <button
            class="notification-trigger"
            id="notificationTrigger"
            title="Notifications"
          >
            <span class="material-symbols-rounded">notifications</span>
            <span class="notification-badge" id="notificationBadge"></span>
          </button>
          <div class="notification-menu" id="notificationMenu">
            <div class="notification-menu-header">
              <h3>Announcements</h3>
            </div>
            <div class="notification-menu-body" id="notificationList"></div>
          </div>
        </div>

        <div class="profile-dropdown">
          <button class="profile-trigger" id="profileTrigger">
            <img
              src=""
              alt="Profile"
              class="profile-avatar"
              id="headerProfilePic"
            />
            <div class="profile-info">
              <div class="profile-name" id="headerProfileName">Loading...</div>
              <div class="profile-role">Citizen</div>
            </div>
            <span class="material-symbols-rounded profile-dropdown-icon"
              >expand_more</span
            >
          </button>
          <div class="profile-dropdown-menu" id="profileDropdown">
            <a href="my-profile" class="dropdown-item">
              <span class="material-symbols-rounded">person</span>
              My Profile
            </a>
            <a href="my-submissions" class="dropdown-item">
              <span class="material-symbols-rounded">description</span>
              My Submissions
            </a>
            <a href="#" class="dropdown-item logout" id="headerLogout">
              <span class="material-symbols-rounded">logout</span>
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <div class="header-brand">
          <div class="header-brand centered-logo">
            <img
              src="{{ url_for('static', filename='images/Civicsense.png') }}"
              alt="Civicsense AI Logo"
              class="logo-img light-mode-logo"
            />
            <img
              src="{{ url_for('static', filename='images/Civicsense-dark.png') }}"
              alt="Civicsense AI Logo Dark"
              class="logo-img dark-mode-logo"
            />
          </div>
        </div>
      </div>

      <div class="sidebar-content">
        <!-- Main Menu -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="dashboard" class="menu-link active">
                <span class="material-symbols-rounded menu-icon"
                  >dashboard</span
                >
                <span class="menu-label">Dashboard</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="report-issue" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >report_problem</span
                >
                <span class="menu-label">Report an Issue</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="my-submissions" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >description</span
                >
                <span class="menu-label">My Submissions</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="check-status" class="menu-link">
                <span class="material-symbols-rounded menu-icon">task_alt</span>
                <span class="menu-label">Check Status</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- AI & Analytics -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="{{ url_for('ai_chatbot') }}" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >smart_toy</span
                >
                <span class="menu-label">AI Chatbot</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="analytics" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >trending_up</span
                >
                <span class="menu-label">Analytics & Trends</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Support -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="feedback" class="menu-link">
                <span class="material-symbols-rounded menu-icon"
                  >star_rate</span
                >
                <span class="menu-label">Feedback & Rating</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="help-support" class="menu-link">
                <span class="material-symbols-rounded menu-icon">help</span>
                <span class="menu-label">Help/Support</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="about-us" class="menu-link">
                <span class="material-symbols-rounded menu-icon">info</span>
                <span class="menu-label">About Us</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Account -->
        <div class="menu-section">
          <ul class="menu-list">
            <li class="menu-item">
              <a href="my-profile" class="menu-link">
                <img
                  src=""
                  alt="My Profile"
                  id="sidebarProfilePic"
                  class="sidebar-profile-pic"
                />
                <span class="menu-label">My Profile</span>
              </a>
            </li>

            <li class="menu-item">
              <a href="logout" class="menu-link logout-menu-link">
                <span class="material-symbols-rounded menu-icon">logout</span>
                <span class="menu-label">Logout</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Theme Toggle -->
        <button class="theme-toggle">
          <div class="theme-label">
            <span class="material-symbols-rounded">dark_mode</span>
            <span class="theme-text">Dark Mode</span>
          </div>
          <div class="theme-toggle-track">
            <div class="theme-toggle-indicator"></div>
          </div>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <div class="main-content-inner">
        <div class="page-header">
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">
              Welcome back, <span id="welcomeName">{{ first_name }}</span>!
              <span
                id="currentDate"
                style="display: block; margin-top: 4px; font-size: 0.95rem"
              ></span>
            </p>
          </div>
          <a href="{{ url_for('report_issue') }}" class="header-cta-button">
            <span class="material-symbols-rounded">add_circle</span>
            Report New Issue
          </a>
        </div>
        <div class="status-cards">
          <div class="status-card card-submissions">
            <div class="card-header">
              <div class="card-title">Total Submissions</div>
              <div
                class="card-icon"
                style="background: var(--color-hover-primary)"
              >
                <span class="material-symbols-rounded">description</span>
              </div>
            </div>
            <div class="card-value" id="totalSubmissions">Loading...</div>
            <div class="card-description" id="totalSubmissionsDesc">
              Your total issue reports
            </div>
          </div>

          <div class="status-card card-pending">
            <div class="card-header">
              <div class="card-title">Pending Issues</div>
              <div class="card-icon" style="background: var(--color-warning)">
                <span class="material-symbols-rounded">hourglass_top</span>
              </div>
            </div>
            <div class="card-value" id="pendingIssues">Loading...</div>
            <div class="card-description" id="pendingIssuesDesc">
              Awaiting review or action
            </div>
          </div>

          <div class="status-card card-progress">
            <div class="card-header">
              <div class="card-title">In Progress</div>
              <div class="card-icon" style="background: var(--color-accent)">
                <span class="material-symbols-rounded">sync</span>
              </div>
            </div>
            <div class="card-value" id="inProgressIssues">Loading...</div>
            <div class="card-description" id="inProgressIssuesDesc">
              Actively being resolved
            </div>
          </div>

          <div class="status-card card-resolved">
            <div class="card-header">
              <div class="card-title">Resolved Issues</div>
              <div class="card-icon" style="background: #10b981">
                <span class="material-symbols-rounded">task_alt</span>
              </div>
            </div>
            <div class="card-value" id="resolvedIssues">Loading...</div>
            <div class="card-description" id="resolvedIssuesDesc">
              Successfully completed
            </div>
          </div>
        </div>
        <div class="status-card">
          <div class="card-header">
            <div class="card-title">Your Submissions</div>
            <button
              id="refreshSubmissions"
              style="
                background: none;
                border: none;
                color: var(--color-hover-primary);
                cursor: pointer;
                font-size: 1.2rem;
              "
            >
              <span class="material-symbols-rounded">refresh</span>
            </button>
          </div>
          <table class="recent-submissions-table">
            <thead>
              <tr>
                <th>Issue ID</th>
                <th>Category</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="recentSubmissionsBody">
              <tr>
                <td
                  colspan="4"
                  style="
                    text-align: center;
                    padding: 20px;
                    color: var(--color-text-secondary);
                  "
                >
                  Loading recent submissions...
                </td>
              </tr>

              <tr id="noResultsRow" style="display: none">
                <td
                  colspan="4"
                  style="
                    text-align: center;
                    padding: 40px;
                    color: var(--color-text-secondary);
                  "
                >
                  <span
                    class="material-symbols-rounded"
                    style="font-size: 48px; opacity: 0.3"
                    >search_off</span
                  >
                  <div style="margin-top: 12px">
                    No submissions match your search.
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="pagination-container" id="paginationContainer"></div>
        </div>

        <div class="status-card" style="margin-top: 20px">
          <div class="card-header">
            <div class="card-title">Issue Categories</div>
          </div>
          <div id="categoryChart" style="margin-top: 20px">
            <div
              style="
                text-align: center;
                color: var(--color-text-secondary);
                padding: 40px 20px;
              "
            >
              <span
                class="material-symbols-rounded"
                style="
                  font-size: 60px;
                  color: var(--color-bg-secondary);
                  margin-bottom: 16px;
                "
                >pie_chart</span
              >
              <div>Category distribution will be displayed here</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="status-card" style="margin-top: 20px">
          <div class="card-header">
            <div class="card-title">Quick Actions</div>
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 16px;
              margin-top: 20px;
            "
          >
            <a
              href="report-issue"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: var(--color-hover-primary);
                color: white;
                text-decoration: none;
                border-radius: 12px;
                transition: all 0.3s ease;
              "
            >
              <span class="material-symbols-rounded">add_circle</span>
              <span>Report New Issue</span>
            </a>
            <a
              href="check-status"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: var(--color-accent);
                color: white;
                text-decoration: none;
                border-radius: 12px;
                transition: all 0.3s ease;
              "
            >
              <span class="material-symbols-rounded">search</span>
              <span>Check Status</span>
            </a>
            <a
              href="analytics"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: var(--color-warning);
                color: white;
                text-decoration: none;
                border-radius: 12px;
                transition: all 0.3s ease;
              "
            >
              <span class="material-symbols-rounded">trending_up</span>
              <span>View Analytics</span>
            </a>
            <a
              href="{{ url_for('ai_chatbot') }}"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: #8b5cf6;
                color: white;
                text-decoration: none;
                border-radius: 12px;
                transition: all 0.3s ease;
              "
            >
              <span class="material-symbols-rounded">smart_toy</span>
              <span>AI Assistant</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="footer-section">
        <div class="footer-content">
          <div class="footer-copyright">
            Copyright Â© 2025 Civicsense AI. All rights reserved.
          </div>
          <div class="footer-developer">
            Developed by <a href="team-details">Team UNIQUE</a>
          </div>
        </div>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- Chart Instance Variable ---
        let categoryChartInstance = null;

        // --- DOM Elements ---
        const sidebar = document.querySelector(".sidebar");
        const sidebarToggle = document.querySelector(".sidebar-toggle");
        const mobileToggle = document.querySelector(".mobile-toggle");
        const mobileOverlay = document.querySelector(".mobile-overlay");
        const themeToggle = document.querySelector(".theme-toggle");
        const themeIcon = themeToggle.querySelector(
          ".material-symbols-rounded"
        );
        const logoutLink = document.querySelector(".logout-menu-link");
        const profileTrigger = document.getElementById("profileTrigger");
        const profileDropdown = document.getElementById("profileDropdown");
        const headerLogout = document.getElementById("headerLogout");
        const totalSubmissions = document.getElementById("totalSubmissions");
        const pendingIssues = document.getElementById("pendingIssues");
        const inProgressIssues = document.getElementById("inProgressIssues");
        const resolvedIssues = document.getElementById("resolvedIssues");
        const recentSubmissionsBody = document.getElementById(
          "recentSubmissionsBody"
        );
        const refreshButton = document.getElementById("refreshSubmissions");
        const categoryChartContainer = document.getElementById("categoryChart");

        // NEW: Elements for Pagination and Search
        const paginationContainer = document.getElementById(
          "paginationContainer"
        );
        const headerSearchInput = document.getElementById("headerSearchInput");
        const noResultsRow = document.getElementById("noResultsRow");

        // --- Profile Dropdown Management ---
        profileTrigger.addEventListener("click", (e) => {
          e.stopPropagation();
          const isActive = profileTrigger.classList.toggle("active");
          profileDropdown.classList.toggle("show", isActive);
        });

        document.addEventListener("click", (e) => {
          if (
            !profileTrigger.contains(e.target) &&
            !profileDropdown.contains(e.target)
          ) {
            profileTrigger.classList.remove("active");
            profileDropdown.classList.remove("show");
          }
        });

        headerLogout.addEventListener("click", (e) => {
          e.preventDefault();
          if (confirm("Are you sure you want to logout?")) {
            window.location.href = "/logout";
          }
        });

        // ADD THIS NEW FUNCTION to load announcements

        async function loadAnnouncements() {
          const notificationBadge =
            document.getElementById("notificationBadge");
          const notificationList = document.getElementById("notificationList");

          try {
            const response = await fetch("/api/announcements");
            if (!response.ok) throw new Error("Could not fetch announcements.");

            const announcements = await response.json();

            // Update badge
            if (announcements.length > 0) {
              notificationBadge.textContent = announcements.length;
              notificationBadge.classList.add("visible");
            } else {
              notificationBadge.classList.remove("visible");
            }

            // Update dropdown list
            notificationList.innerHTML = ""; // Clear previous items
            if (announcements.length > 0) {
              announcements.forEach((ann) => {
                const item = document.createElement("div");
                item.className = "notification-item";
                // ... inside the loadAnnouncements function
                item.innerHTML = `
<div class="notification-title">
        <span class="material-symbols-rounded admin-icon">admin_panel_settings</span>
        <span>${ann.title}</span>
    </div>                  <div class="notification-date">${new Date(
      ann.created_at
    ).toLocaleString("en-IN", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
      timeZone: "Asia/Kolkata", // This line ensures correct time
    })}</div>
                  <p class="notification-content">${ann.content}</p>
              `;
                notificationList.appendChild(item);
              });
            } else {
              notificationList.innerHTML = `
                <div class="no-notifications">
                    <span class="material-symbols-rounded">notifications_off</span>
                    <p>No new announcements</p>
                </div>
            `;
            }
          } catch (error) {
            console.error("Error loading announcements:", error);
            notificationList.innerHTML = `<div class="no-notifications"><p>Could not load announcements.</p></div>`;
          }
        }

        // ADD THESE EVENT LISTENERS for the notification dropdown

        const notificationTrigger = document.getElementById(
          "notificationTrigger"
        );
        const notificationMenu = document.getElementById("notificationMenu");

        notificationTrigger.addEventListener("click", (e) => {
          e.stopPropagation();
          notificationMenu.classList.toggle("show");
        });

        document.addEventListener("click", (e) => {
          if (
            !notificationTrigger.contains(e.target) &&
            !notificationMenu.contains(e.target)
          ) {
            notificationMenu.classList.remove("show");
          }
        });

        // --- Data Loading Functions ---

        // Load Profile Data
        async function loadProfileData() {
          try {
            const response = await fetch("/api/user/profile");
            if (!response.ok) return;
            const data = await response.json();
            const headerProfilePic =
              document.getElementById("headerProfilePic");
            const headerProfileName =
              document.getElementById("headerProfileName");
            const sidebarProfilePic =
              document.getElementById("sidebarProfilePic");
            if (data.photo_url) {
              headerProfilePic.src = data.photo_url;
              sidebarProfilePic.src = data.photo_url;
            } else {
              const defaultPhoto =
                "{{ url_for('static', filename='images/female_avatar.png') }}";
              headerProfilePic.src = defaultPhoto;
              sidebarProfilePic.src = defaultPhoto;
            }
            const fullName = `${data.first_name || ""} ${
              data.last_name || ""
            }`.trim();
            headerProfileName.textContent = fullName || "User";

            // ADD THESE TWO LINES
            const welcomeName = document.getElementById("welcomeName");
            if (welcomeName) welcomeName.textContent = fullName || "User";
          } catch (error) {
            console.error("Could not load profile data:", error);
            document.getElementById("headerProfileName").textContent = "User";
          }
        }
        // Load Dashboard Stats
        async function loadDashboardStats() {
          try {
            const response = await fetch("/api/dashboard/stats");
            if (!response.ok) throw new Error("Failed to fetch stats");
            const data = await response.json();
            updateStatCard(totalSubmissions, data.total_submissions || 0);
            updateStatCard(pendingIssues, data.pending_issues || 0);
            updateStatCard(inProgressIssues, data.in_progress_issues || 0);
            updateStatCard(resolvedIssues, data.resolved_issues || 0);
          } catch (error) {
            console.error("Error loading dashboard stats:", error);
            totalSubmissions.textContent = "Error";
            pendingIssues.textContent = "Error";
            inProgressIssues.textContent = "Error";
            resolvedIssues.textContent = "Error";
          }
        }

        // MODIFIED: Load Recent Submissions with Pagination
        async function loadRecentSubmissions(page = 1) {
          try {
            recentSubmissionsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px;">Loading submissions...</td></tr>`;
            const response = await fetch(
              `/api/dashboard/recent-submissions?page=${page}`
            );
            if (!response.ok) throw new Error("Failed to fetch submissions");
            const data = await response.json();

            // Clear only the loading row
            recentSubmissionsBody.innerHTML = "";

            if (data.submissions && data.submissions.length > 0) {
              data.submissions.forEach((submission) => {
                const row = document.createElement("tr");
                row.classList.add("submission-row"); // Add class for easy selection
                row.innerHTML = `
              <td style="font-weight: 500; color: var(--color-hover-primary);">${
                submission.issue_id
              }</td>
              <td>${submission.category}</td>
              <td><span class="status-badge-table status-${submission.status
                .toLowerCase()
                .replace(" ", "-")}">${submission.status}</span></td>
              <td>${submission.date}</td>
            `;
                recentSubmissionsBody.appendChild(row);
              });
            } else {
              recentSubmissionsBody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                <span class="material-symbols-rounded" style="font-size: 48px; opacity: 0.3;">inbox</span>
                <div style="margin-top: 12px;">No submissions yet. <a href="report-issue" style="color: var(--color-hover-primary);">Report your first issue</a></div>
              </td>
            </tr>`;
            }

            // Add the 'no results' row back in for search functionality
            recentSubmissionsBody.appendChild(noResultsRow);

            renderPaginationControls(data.pagination);
            handleSearch(); // Apply search filter if there's existing search text
          } catch (error) {
            console.error("Error loading recent submissions:", error);
            recentSubmissionsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--color-error);">Error loading submissions</td></tr>`;
          }
        }

        // NEW: Function to Render Pagination Controls
        function renderPaginationControls(pagination) {
          paginationContainer.innerHTML = "";
          if (!pagination || pagination.totalPages <= 1) return;

          const { currentPage, totalPages } = pagination;

          const prevButton = document.createElement("button");
          prevButton.textContent = "Prev";
          prevButton.className = "pagination-button";
          prevButton.disabled = currentPage === 1;
          prevButton.addEventListener("click", () =>
            loadRecentSubmissions(currentPage - 1)
          );
          paginationContainer.appendChild(prevButton);

          for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement("button");
            pageButton.textContent = i;
            pageButton.className = "pagination-button";
            if (i === currentPage) {
              pageButton.classList.add("active");
            }
            pageButton.addEventListener("click", () =>
              loadRecentSubmissions(i)
            );
            paginationContainer.appendChild(pageButton);
          }

          const nextButton = document.createElement("button");
          nextButton.textContent = "Next";
          nextButton.className = "pagination-button";
          nextButton.disabled = currentPage === totalPages;
          nextButton.addEventListener("click", () =>
            loadRecentSubmissions(currentPage + 1)
          );
          paginationContainer.appendChild(nextButton);
        }

        // NEW: Search Handler Function
        function handleSearch() {
          const searchTerm = headerSearchInput.value.toLowerCase().trim();
          const rows =
            recentSubmissionsBody.querySelectorAll("tr.submission-row");
          let visibleRows = 0;

          rows.forEach((row) => {
            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(searchTerm)) {
              row.style.display = "";
              visibleRows++;
            } else {
              row.style.display = "none";
            }
          });

          paginationContainer.style.display = searchTerm ? "none" : "flex";

          if (visibleRows === 0 && searchTerm) {
            noResultsRow.style.display = "";
          } else {
            noResultsRow.style.display = "none";
          }
        }

        // Load Category Chart
        async function loadCategoryChart() {
          try {
            const response = await fetch("/api/dashboard/category-stats");
            if (!response.ok) throw new Error("Failed to fetch category stats");
            const data = await response.json();
            categoryChartContainer.innerHTML = "";
            if (data.categories && data.categories.length > 0) {
              const isDark = document.body.classList.contains("dark-theme");
              const chartOptions = {
                series: data.categories.map((c) => c.count),
                labels: data.categories.map((c) => c.category),
                chart: {
                  type: "donut",
                  height: 350,
                  background: "transparent",
                },
                theme: { mode: isDark ? "dark" : "light", palette: "palette1" },
                legend: { position: "bottom" },
                responsive: [
                  {
                    breakpoint: 480,
                    options: {
                      chart: { width: "100%" },
                      legend: { position: "bottom" },
                    },
                  },
                ],
              };
              if (categoryChartInstance) {
                categoryChartInstance.destroy();
              }
              categoryChartInstance = new ApexCharts(
                categoryChartContainer,
                chartOptions
              );
              categoryChartInstance.render();
            } else {
              categoryChartContainer.innerHTML = `<div style="text-align: center; color: var(--color-text-secondary); padding: 40px 20px;"><span class="material-symbols-rounded" style="font-size: 60px; color: var(--color-bg-secondary); margin-bottom: 16px;">pie_chart</span><div>No category data to display yet.</div></div>`;
            }
          } catch (error) {
            console.error("Error loading category chart:", error);
            categoryChartContainer.innerHTML = `<div style="text-align: center; color: var(--color-error); padding: 20px;">Error loading chart data.</div>`;
          }
        }

        // Utility Functions
        function updateStatCard(element, newValue) {
          const currentValue = parseInt(element.textContent) || 0;
          element.parentElement.classList.add("loading");
          setTimeout(() => {
            if (currentValue !== newValue) {
              animateValue(element, currentValue, newValue, 1000);
            } else {
              element.textContent = newValue.toLocaleString();
            }
            element.parentElement.classList.remove("loading");
          }, 300);
        }

        function animateValue(element, start, end, duration) {
          const startTime = performance.now();
          const difference = end - start;
          function updateValue(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentValue = Math.floor(start + difference * progress);
            element.textContent = currentValue.toLocaleString();
            if (progress < 1) {
              requestAnimationFrame(updateValue);
            }
          }
          requestAnimationFrame(updateValue);
        }

        // --- Event Listeners & Initialization ---

        // NEW: Search Event Listener
        headerSearchInput.addEventListener("keyup", handleSearch);

        // MODIFIED: Refresh functionality to handle current page
        refreshButton.addEventListener("click", () => {
          refreshButton.style.transform = "rotate(360deg)";
          refreshButton.style.transition = "transform 0.6s ease";

          const currentPage = parseInt(
            paginationContainer.querySelector(".pagination-button.active")
              ?.textContent || "1"
          );
          loadRecentSubmissions(currentPage); // Refresh the current page
          loadDashboardStats();
          loadCategoryChart();

          setTimeout(() => {
            refreshButton.style.transform = "rotate(0deg)";
            refreshButton.style.transition = "transform 0.3s ease";
          }, 600);
        });

        // Theme Management
        const updateThemeIcon = () => {
          const isDark = document.body.classList.contains("dark-theme");
          if (themeIcon) {
            themeIcon.textContent = isDark ? "light_mode" : "dark_mode";
          }
        };
        const savedTheme = localStorage.getItem("civicsense-theme");
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const shouldUseDarkTheme =
          savedTheme === "dark" || (!savedTheme && systemPrefersDark);
        document.body.classList.toggle("dark-theme", shouldUseDarkTheme);
        updateThemeIcon();
        themeToggle.addEventListener("click", () => {
          const isDark = document.body.classList.toggle("dark-theme");
          localStorage.setItem("civicsense-theme", isDark ? "dark" : "light");
          updateThemeIcon();
          loadCategoryChart();
        });

        // Sidebar and Mobile Menu
        if (sidebarToggle) {
          sidebarToggle.addEventListener("click", () =>
            sidebar.classList.toggle("collapsed")
          );
        }
        if (mobileToggle) {
          mobileToggle.addEventListener("click", () => {
            sidebar.classList.toggle("open");
            if (mobileOverlay) mobileOverlay.classList.toggle("active");
          });
        }
        if (mobileOverlay) {
          mobileOverlay.addEventListener("click", () => {
            sidebar.classList.remove("open");
            mobileOverlay.classList.remove("active");
          });
        }

        // Logout
        if (logoutLink) {
          logoutLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (confirm("Are you sure you want to logout?")) {
              window.location.href = "/logout";
            }
          });
        }

        // Window Resize Handler
        const handleResize = () => {
          if (window.innerWidth > 768) {
            sidebar.classList.remove("collapsed", "open");
            if (mobileOverlay) mobileOverlay.classList.remove("active");
          }
        };
        window.addEventListener("resize", handleResize);

        // --- Initial Data Load ---
        function initializeDashboard() {
          // ADD THIS LINE
          document.getElementById("currentDate").textContent =
            new Date().toLocaleDateString("en-US", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });

          loadProfileData();
          loadDashboardStats();
          loadRecentSubmissions(1); // MODIFIED: Load the first page initially
          loadCategoryChart();
          loadAnnouncements(); // <-- ADD THIS LINE

          console.log(
            "Civicsense AI Dynamic Dashboard initialized successfully!"
          );
        }

        initializeDashboard();
      });
    </script>
  </body>
</html>
